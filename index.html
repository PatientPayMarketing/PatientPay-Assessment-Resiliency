<!DOCTYPE html>
<!--
  ============================================
  PATIENTPAY AMBULATORY PRACTICE RESILIENCY ASSESSMENT
  UI VERSION: v1-dark-premium-segment (ROOT)
  CREATED: February 2026
  ============================================

  ARCHITECTURE:
  This file uses the shared core engine for all business logic.
  UI-specific code only - no questions, scoring, or calculations here.

  CORE ENGINE: ./core/assessment-engine.js (v1.0)
  - Practice type routing with 6 segments (PP, PT, BH, UC, ASC, FC)
  - All segments use THREE categories: Revenue Cycle Resilience, Patient Payment Experience, Competitive Position
  - Segment-specific category weights
  - Autopay as featured value proposition
  - Results flow definition (7 slides)
  - Simplified webhook payload
  - Export functions (CSV, PDF, webhook)

  DESIGN PHILOSOPHY:
  Show-stopping, conversation-starting UI that makes people
  stop and call their friends. Every transition is an event.

  STANDALONE: No - imports from core/assessment-engine.js
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- V4.13: Content Security Policy - restricts resource loading to known origins -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self' https://hook.us2.make.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ambulatory Practice Financial Resiliency Assessment</title>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800;900&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- V4.13: Pinned versions with SRI integrity hashes for supply-chain security -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous" integrity="sha384-tMH8h3BGESGckSAVGZ82T9n90ztNXxvdwvdM6UoR56cYcf+0iGXBliJ29D+wZ/x8"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous" integrity="sha384-bm7MnzvK++ykSwVJ2tynSE5TRdN+xL418osEVF2DE/L/gfWHj91J2Sphe582B1Bh"></script>
  <script src="https://unpkg.com/@babel/standalone@7.26.6/babel.min.js" crossorigin="anonymous" integrity="sha384-dj/7w9lBYA3I0KqC9jHAkmmCoyatRTqnCXX8ZTP4BpAJu2hvvx+w9aEJuFMTuja1"></script>
  <script src="./core/assessment-engine.js"></script>
  <style>
    :root {
      --pp-primary: #072140;
      --pp-secondary: #3c8fc7;
      --pp-accent: #fcc93b;
      --pp-success: #10B981;
      --pp-warning: #F59E0B;
      --pp-error: #EF4444;
      --bg-primary: #050a12;
      --bg-secondary: #0a1628;
      --bg-tertiary: #0f1f35;
      --bg-card: rgba(7, 33, 64, 0.4);
      --bg-glass: rgba(60, 143, 199, 0.08);
      --border-subtle: rgba(60, 143, 199, 0.15);
      --border-glass: rgba(60, 143, 199, 0.25);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-tertiary: rgba(255, 255, 255, 0.55);
      --text-muted: rgba(255, 255, 255, 0.35);
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    /* Hide number input spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    body {
      font-family: 'Manrope', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Grain texture */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.02;
      pointer-events: none;
      z-index: 10000;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    h1, h2, h3, h4, h5, h6 { font-family: 'Archivo', sans-serif; }

    .glass-card {
      background: var(--bg-glass);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-glass);
      border-radius: 28px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3c8fc7 0%, #072140 50%, #fcc93b 100%);
      color: white;
      border: none;
      padding: 18px 36px;
      border-radius: 16px;
      font-family: 'Archivo', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.4s var(--ease-out-expo);
      box-shadow: 0 4px 20px rgba(60, 143, 199, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 40px rgba(60, 143, 199, 0.5), 0 0 80px rgba(252, 201, 59, 0.3);
    }

    .btn-secondary {
      background: rgba(60, 143, 199, 0.1);
      color: var(--text-primary);
      border: 1px solid var(--border-glass);
      padding: 18px 36px;
      border-radius: 16px;
      font-family: 'Archivo', sans-serif;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.4s var(--ease-out-expo);
    }

    .btn-secondary:hover {
      background: rgba(60, 143, 199, 0.2);
      border-color: var(--pp-secondary);
      transform: translateY(-2px);
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background: var(--bg-tertiary);
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3c8fc7, #fcc93b);
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(60, 143, 199, 0.5);
      transition: transform 0.3s var(--spring);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .input-field {
      width: 100%;
      padding: 18px 24px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 16px;
      font-family: 'Manrope', sans-serif;
      transition: all 0.4s var(--ease-out-expo);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--pp-secondary);
      box-shadow: 0 0 0 4px rgba(60, 143, 199, 0.15);
    }

    .option-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 18px;
      padding: 22px 28px;
      cursor: pointer;
      transition: all 0.4s var(--ease-out-expo);
      display: flex;
      align-items: center;
      gap: 18px;
      position: relative;
      overflow: hidden;
    }

    .option-card:hover {
      background: rgba(7, 33, 64, 0.6);
      border-color: var(--pp-secondary);
      transform: translateX(8px);
    }

    .option-card.selected {
      background: rgba(60, 143, 199, 0.15);
      border-color: var(--pp-secondary);
      box-shadow: 0 0 30px rgba(60, 143, 199, 0.2);
    }

    /* Epic keyframes */
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(10px, -10px); }
      50% { transform: translate(-5px, 5px); }
      75% { transform: translate(5px, 10px); }
    }

    @keyframes particleFloat {
      0%, 100% { transform: translateY(0) translateX(0); opacity: 0.6; }
      25% { transform: translateY(-20px) translateX(10px); opacity: 0.8; }
      50% { transform: translateY(-10px) translateX(-5px); opacity: 0.4; }
      75% { transform: translateY(-30px) translateX(5px); opacity: 0.7; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(60px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0) scale(1); }
      to { opacity: 0; transform: translateX(-100px) scale(0.95); }
    }

    @keyframes slideInFromRight {
      from { opacity: 0; transform: translateX(100px) scale(0.95); }
      to { opacity: 1; transform: translateX(0) scale(1); }
    }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes rotateGradient {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes celebratePulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(60, 143, 199, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(60, 143, 199, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(60, 143, 199, 0); }
    }

    @keyframes scoreReveal {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      60% { transform: scale(1.2) rotate(10deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    @keyframes ripple {
      0% { transform: scale(0) translate(-50%, -50%); opacity: 0.6; }
      100% { transform: scale(4) translate(-50%, -50%); opacity: 0; }
    }

    @keyframes cardFlip {
      0% { transform: perspective(1000px) rotateY(0deg); }
      100% { transform: perspective(1000px) rotateY(180deg); }
    }

    @keyframes morphIn {
      0% { clip-path: circle(0% at 50% 50%); }
      100% { clip-path: circle(100% at 50% 50%); }
    }

    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(60, 143, 199, 0.3); }
      50% { box-shadow: 0 0 60px rgba(60, 143, 199, 0.6), 0 0 100px rgba(252, 201, 59, 0.3); }
    }

    @keyframes numberPop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes textReveal {
      0% { clip-path: inset(0 100% 0 0); }
      100% { clip-path: inset(0 0 0 0); }
    }

    @keyframes barGrow {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* V4.12.1: Ultra-premium micro-interactions */
    @keyframes subtleLift {
      0% { transform: translateY(0) scale(1); }
      100% { transform: translateY(-4px) scale(1.02); }
    }

    @keyframes borderGlow {
      0% { box-shadow: 0 0 0 0 rgba(60, 143, 199, 0); }
      50% { box-shadow: 0 0 20px 2px rgba(60, 143, 199, 0.3); }
      100% { box-shadow: 0 0 0 0 rgba(60, 143, 199, 0); }
    }

    @keyframes countUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes iconBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    @keyframes successCheck {
      0% { stroke-dashoffset: 50; }
      100% { stroke-dashoffset: 0; }
    }

    @keyframes statPop {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    /* Premium pillar hover states */
    .pillar-card {
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pillar-card:hover {
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .pillar-card:hover .pillar-icon {
      animation: iconBounce 0.6s ease-in-out;
    }

    /* Stat card animations */
    .stat-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      background: rgba(60, 143, 199, 0.08) !important;
    }

    /* Summary card premium effects */
    .summary-card-premium {
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .summary-card-premium:hover {
      transform: scale(1.01);
      box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 40px rgba(252,201,59,0.15);
    }

    /* CTA link hover */
    .cta-link {
      position: relative;
      transition: all 0.3s ease;
    }

    .cta-link::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #10B981, #3c8fc7);
      transition: width 0.3s ease;
    }

    .cta-link:hover::after {
      width: 100%;
    }

    .cta-link:hover {
      color: #10B981;
      transform: translateX(4px);
    }

    /* Glass card hover enhancement */
    .glass-card-interactive {
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .glass-card-interactive:hover {
      transform: translateY(-3px);
      border-color: rgba(60, 143, 199, 0.4);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    // V4.10: Error Boundary to catch render errors
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      componentDidCatch(error, errorInfo) {
        console.error('ErrorBoundary caught error:', error, errorInfo);
        this.setState({ error, errorInfo });
      }
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: 40, background: '#1a1a2e', color: '#fff', minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', textAlign: 'center' }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>&#9888;</div>
              <h1 style={{ color: '#fff', fontSize: 24, marginBottom: 8 }}>Something went wrong</h1>
              <p style={{ color: 'rgba(255,255,255,0.6)', fontSize: 14, maxWidth: 400, lineHeight: 1.6, marginBottom: 24 }}>
                We encountered an unexpected issue loading the assessment. Please reload the page to try again.
              </p>
              <button onClick={() => window.location.reload()} style={{ padding: '12px 28px', background: '#3c8fc7', color: '#fff', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, fontWeight: 600 }}>
                Reload Page
              </button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ============================================
    // IMPORTS FROM CORE ENGINE
    // All business logic comes from the shared engine
    // ============================================
    const {
      questions,
      categoryNames,
      getCategoryName,
      resultsFlow,
      resultsFlowV47,
      sources,
      practiceTypes,
      stats,
      industryBenchmarks,
      getVisibleQuestions,
      calculateScores,
      calculateQuestionScore,
      getScoreLevel,
      getScoreColor,
      calculateInsights,
      getActionableRecommendations,
      getGapAnalysis,
      getStrengths,
      calculatePatientPayProjections,
      getPerformanceVsBenchmark,
      prepareExportData,
      generateCSV,
      downloadPDFReport,
      sendWebhook
    } = window.AssessmentEngine;

    // Backwards compat aliases
    const facilityTypes = practiceTypes;
    const snfCategoryNames = categoryNames;

    // UI-specific color mapping for categories
    const categoryColors = ['#3c8fc7', '#8B5CF6', '#fcc93b'];

    // Segment colors for visual differentiation
    const segmentColors = {
      PP: '#3c8fc7',   // Blue - physician practice
      PT: '#10B981',   // Green - physical therapy
      BH: '#8B5CF6',   // Purple - behavioral health
      UC: '#F59E0B',   // Amber - urgent care
      ASC: '#fcc93b',  // Yellow - surgery center
      FC: '#EC4899'    // Pink - fertility
    };

    // ============================================
    // GLOBAL PARTICLE SYSTEM - Persistent throughout
    // ============================================
    const ParticleField = React.memo(() => {
      const particles = useMemo(() => Array.from({ length: 50 }, (_, i) => ({
        id: i,
        size: Math.random() * 4 + 1,
        x: Math.random() * 100,
        y: Math.random() * 100,
        duration: Math.random() * 30 + 20,
        delay: Math.random() * 20,
        color: Math.random() > 0.7 ? '#fcc93b' : Math.random() > 0.5 ? '#3c8fc7' : '#5ba3d4'
      })), []);

      return (
        <div style={{ position: 'fixed', inset: 0, pointerEvents: 'none', zIndex: 1, overflow: 'hidden' }}>
          {particles.map(p => (
            <div key={p.id} style={{
              position: 'absolute',
              width: p.size,
              height: p.size,
              left: `${p.x}%`,
              top: `${p.y}%`,
              background: p.color,
              borderRadius: '50%',
              opacity: 0.4,
              animation: `particleFloat ${p.duration}s ease-in-out infinite`,
              animationDelay: `${p.delay}s`,
              boxShadow: `0 0 ${p.size * 2}px ${p.color}`,
            }} />
          ))}
        </div>
      );
    });

    // Gradient orbs
    const GradientOrbs = React.memo(() => (
      <>
        <div style={{
          position: 'fixed', width: 700, height: 700, borderRadius: '50%',
          background: 'radial-gradient(circle, #3c8fc7 0%, transparent 70%)',
          top: -250, right: -200, filter: 'blur(100px)', opacity: 0.4,
          animation: 'float 25s ease-in-out infinite', pointerEvents: 'none', zIndex: 0
        }} />
        <div style={{
          position: 'fixed', width: 600, height: 600, borderRadius: '50%',
          background: 'radial-gradient(circle, #072140 0%, transparent 70%)',
          bottom: -200, left: -200, filter: 'blur(100px)', opacity: 0.5,
          animation: 'float 25s ease-in-out infinite', animationDelay: '-8s', pointerEvents: 'none', zIndex: 0
        }} />
        <div style={{
          position: 'fixed', width: 400, height: 400, borderRadius: '50%',
          background: 'radial-gradient(circle, #fcc93b 0%, transparent 70%)',
          top: '40%', left: '60%', filter: 'blur(100px)', opacity: 0.2,
          animation: 'float 25s ease-in-out infinite', animationDelay: '-16s', pointerEvents: 'none', zIndex: 0
        }} />
      </>
    ));

    // ============================================
    // ANIMATED COMPONENTS
    // ============================================
    const AnimatedNumber = ({ value, prefix = '', suffix = '', duration = 1500, delay = 0 }) => {
      const [display, setDisplay] = useState(0);
      const [started, setStarted] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setStarted(true), delay);
        return () => clearTimeout(timer);
      }, [delay]);

      useEffect(() => {
        if (!started) return;
        const startTime = performance.now();
        const animate = (currentTime) => {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 4);
          setDisplay(Math.round(value * eased));
          if (progress < 1) requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);
      }, [value, duration, started]);

      return <span>{prefix}{display.toLocaleString()}{suffix}</span>;
    };

    const ProgressRing = ({ progress, size = 200, strokeWidth = 12, delay = 0 }) => {
      const [animatedProgress, setAnimatedProgress] = useState(0);
      const radius = (size - strokeWidth) / 2;
      const circumference = radius * 2 * Math.PI;

      useEffect(() => {
        const timer = setTimeout(() => {
          const startTime = performance.now();
          const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const p = Math.min(elapsed / 1500, 1);
            const eased = 1 - Math.pow(1 - p, 4);
            setAnimatedProgress(progress * eased);
            if (p < 1) requestAnimationFrame(animate);
          };
          requestAnimationFrame(animate);
        }, delay);
        return () => clearTimeout(timer);
      }, [progress, delay]);

      const offset = circumference - (animatedProgress / 100) * circumference;

      return (
        <svg width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>
          <defs>
            <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stopColor="#3c8fc7" />
              <stop offset="100%" stopColor="#fcc93b" />
            </linearGradient>
            <filter id="glow">
              <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
              <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke="rgba(60,143,199,0.1)" strokeWidth={strokeWidth} />
          <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke="url(#ringGradient)" strokeWidth={strokeWidth}
            strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={offset} filter="url(#glow)"
            style={{ transition: 'stroke-dashoffset 0.1s ease' }} />
        </svg>
      );
    };

    // ============================================
    // WELCOME SCREEN
    // ============================================
    const WelcomeScreen = ({ onStart }) => {
      const [visible, setVisible] = useState(false);
      useEffect(() => { setTimeout(() => setVisible(true), 100); }, []);

      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
          <div style={{
            maxWidth: 900, textAlign: 'center',
            opacity: visible ? 1 : 0, transform: visible ? 'translateY(0)' : 'translateY(60px)',
            transition: 'all 1.2s cubic-bezier(0.16, 1, 0.3, 1)'
          }}>
            <div style={{ marginBottom: 48, position: 'relative' }}>
              <div style={{
                position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
                width: 200, height: 200, background: 'radial-gradient(circle, rgba(60,143,199,0.3) 0%, transparent 70%)',
                filter: 'blur(30px)', animation: 'pulse 3s ease-in-out infinite'
              }} />
              <img src="./assets/patientpay_color.png" alt="PatientPay"
                style={{ height: 80, position: 'relative', filter: 'drop-shadow(0 10px 30px rgba(60,143,199,0.4))' }} />
            </div>

            <h1 style={{
              fontFamily: "'Archivo', sans-serif", fontSize: 'clamp(40px, 7vw, 72px)', fontWeight: 800,
              lineHeight: 1.05, marginBottom: 28,
              background: 'linear-gradient(135deg, #fff 0%, #3c8fc7 50%, #fcc93b 100%)',
              WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent',
              animation: 'fadeInUp 1s ease-out 0.2s both'
            }}>
              Financial Resiliency<br />
              <span style={{ background: 'linear-gradient(135deg, #fcc93b 0%, #fff 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Assessment
              </span>
            </h1>

            <p style={{
              fontSize: 20, color: 'var(--text-secondary)', maxWidth: 600, margin: '0 auto 56px', lineHeight: 1.7,
              animation: 'fadeInUp 1s ease-out 0.3s both'
            }}>
              You can't control rising costs, shifting regulations, or insurance trends. But you can control how resilient your practice is. See where you stand.
            </p>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 20, marginBottom: 56 }}>
              {[{ value: '12-15', label: 'Questions', color: '#3c8fc7' }, { value: '3', label: 'Categories', color: '#fcc93b' }, { value: 'Under 5', label: 'Minutes', color: '#3c8fc7' }].map((stat, i) => (
                <div key={i} className="glass-card" style={{
                  padding: 32, animation: `fadeInUp 0.8s ease-out ${0.4 + i * 0.1}s both`,
                  background: 'rgba(7, 33, 64, 0.6)', border: `1px solid ${stat.color}30`
                }}>
                  <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'Archivo'", color: stat.color,
                    textShadow: `0 0 30px ${stat.color}60`, marginBottom: 8 }}>{stat.value}</div>
                  <div style={{ fontSize: 15, color: '#fff', fontWeight: 600, opacity: 0.9 }}>{stat.label}</div>
                </div>
              ))}
            </div>

            <button className="btn-primary" onClick={onStart}
              style={{ fontSize: 18, padding: '22px 56px', animation: 'fadeInUp 0.8s ease-out 0.7s both' }}>
              Begin Assessment
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 14, verticalAlign: 'middle' }}>
                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </button>

            {/* Industry trust signals */}
            <div style={{
              marginTop: 48,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              gap: 12,
              animation: 'fadeInUp 1s ease-out 0.9s both'
            }}>
              <p style={{
                fontSize: 12,
                color: 'var(--text-muted)',
                maxWidth: 400,
                lineHeight: 1.5,
                textAlign: 'center'
              }}>
                Benchmarked against 288+ industry data points across 6 practice types
              </p>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // CURRENCY FORMATTING UTILITIES
    // ============================================
    const formatCurrency = (value) => {
      if (!value) return '';
      const num = parseInt(value.toString().replace(/[^0-9]/g, ''));
      if (isNaN(num)) return '';
      return num.toLocaleString('en-US');
    };

    const parseCurrencyToNumber = (value) => {
      if (!value) return null;
      const num = parseInt(value.toString().replace(/[^0-9]/g, ''));
      return isNaN(num) ? null : num;
    };

    // ============================================
    // FUNNEL TRACKING - V4.17: Diagnostic events for drop-off analysis
    // ============================================
    const FUNNEL_WEBHOOK_URL = ''; // Placeholder - configure in Make.com

    // Generate a unique session ID once per page load
    const FUNNEL_SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);

    // Track funnel events - fires silently, never blocks user flow
    // Optional contactData parameter for contact_submitted event
    const trackFunnelEvent = (eventName, segment = null, contactData = null) => {
      try {
        const payload = {
          sessionId: FUNNEL_SESSION_ID,
          timestamp: new Date().toISOString(),
          event: eventName,
          segment: segment || '',
          userAgent: navigator.userAgent,
          screenWidth: window.innerWidth,
          screenHeight: window.innerHeight,
          // Contact info (only populated for contact_submitted event)
          name: contactData?.name || '',
          email: contactData?.email || '',
          organization: contactData?.organization || '',
          facilityType: contactData?.facilityType || ''
        };

        // Use fetch with proper JSON headers so Make.com parses fields correctly
        // keepalive: true helps ensure request completes even if page is closing
        fetch(FUNNEL_WEBHOOK_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' },
          keepalive: true
        }).catch(() => {}); // Silent fail - never block user flow
      } catch (e) {
        // Never let tracking break the assessment
      }
    };

    // Fire page_load event immediately
    trackFunnelEvent('page_load');

    // ============================================
    // CONTACT FORM - V4.1: Now includes facility type with segment-conditional fields
    // ============================================
    const ContactForm = ({ onSubmit, onCompetitorBlocked }) => {
      const [formData, setFormData] = useState({
        name: '', email: '', organization: '',
        facilityType: '' // Practice type - captured here instead of as first question
      });
      const [errors, setErrors] = useState({});
      const [focusedField, setFocusedField] = useState(null);
      const [hpField, setHpField] = useState(''); // V4.13: Honeypot for bot detection

      // V4.14: Email domain blacklists
      const FREE_EMAIL_DOMAINS = [
        'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com',
        'icloud.com', 'mail.com', 'protonmail.com', 'zoho.com', 'yandex.com',
        'gmx.com', 'inbox.com', 'live.com', 'msn.com', 'me.com',
        'comcast.net', 'verizon.net', 'att.net', 'sbcglobal.net', 'cox.net'
      ];
      const COMPETITOR_DOMAINS = [
        'instamed.com', 'waystar.com', 'cedar.com', 'collectly.com',
        'inovalon.com', 'revspringinc.com', 'availity.com', 'inboxhealth.com',
        'simplee.com', 'flywire.com', 'swell.com', 'rectanglehealth.com',
        'phreesia.com', 'salucro.com', 'curapay.com'
      ];

      // Practice type options (from core engine)
      const facilityOptions = [
        { value: 'PP', label: 'Physician Practice / Medical Group', desc: 'Primary care, specialty, or multi-specialty groups' },
        { value: 'PT', label: 'Physical Therapy / Rehab', desc: 'PT, OT, speech therapy, rehabilitation clinics' },
        { value: 'BH', label: 'Mental / Behavioral Health', desc: 'Psychiatry, psychology, counseling, substance abuse' },
        { value: 'UC', label: 'Urgent Care', desc: 'Walk-in clinics, retail health, immediate care' },
        { value: 'ASC', label: 'Ambulatory Surgery Center', desc: 'Outpatient surgical and procedural facilities' },
        { value: 'FC', label: 'Fertility Clinic', desc: 'IVF, reproductive medicine, fertility treatment' }
      ];

      const handleSubmit = () => {
        // V4.13: Bot detection - honeypot field should always be empty
        if (hpField) { console.log('Assessment submitted.'); return; }
        const newErrors = {};
        if (!formData.name.trim()) newErrors.name = 'Required';
        if (formData.name.trim().length > 100) newErrors.name = 'Name is too long';
        if (!formData.email.trim()) newErrors.email = 'Required';
        else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email.trim())) newErrors.email = 'Please enter a valid email';
        else {
          // V4.14: Email domain validation
          const emailDomain = formData.email.trim().toLowerCase().split('@')[1];
          if (FREE_EMAIL_DOMAINS.includes(emailDomain)) {
            newErrors.email = 'Please use your business email address';
          } else if (COMPETITOR_DOMAINS.includes(emailDomain)) {
            // Competitor detected - trigger special screen
            onCompetitorBlocked && onCompetitorBlocked();
            return;
          }
        }
        if (!formData.organization.trim()) newErrors.organization = 'Required';
        if (formData.organization.trim().length > 200) newErrors.organization = 'Organization name is too long';
        if (!formData.facilityType) newErrors.facilityType = 'Please select your practice type';
        if (Object.keys(newErrors).length) { setErrors(newErrors); return; }
        onSubmit({
          ...formData,
          name: formData.name.trim().substring(0, 100),
          email: formData.email.trim().substring(0, 254),
          organization: formData.organization.trim().substring(0, 200)
        });
      };

      const handleChange = (field) => (e) => setFormData(prev => ({ ...prev, [field]: e.target.value }));

      const handleCurrencyChange = (field) => (e) => {
        const formatted = formatCurrency(e.target.value);
        setFormData(prev => ({ ...prev, [field]: formatted }));
      };

      const handleFacilitySelect = (value) => {
        setFormData(prev => ({ ...prev, facilityType: value }));
        setErrors(prev => ({ ...prev, facilityType: undefined }));
      };

      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
          <div className="glass-card" style={{ maxWidth: 640, width: '100%', padding: 48, animation: 'scaleIn 0.6s var(--ease-out-expo)' }}>
            <div style={{ marginBottom: 36, textAlign: 'center' }}>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 30, fontWeight: 700, marginBottom: 12,
                background: 'linear-gradient(135deg, #fff 0%, #3c8fc7 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Let's get started
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 16 }}>We'll personalize your assessment based on your practice type.</p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 20 }}>
              {/* Basic contact fields */}
              {[{ label: 'Your Name', field: 'name', required: true },
                { label: 'Email Address', field: 'email', type: 'email', required: true },
                { label: 'Organization', field: 'organization', required: true }].map(f => (
                <div key={f.field}>
                  <label style={{ display: 'block', marginBottom: 8, fontSize: 14, fontWeight: 600, fontFamily: "'Archivo'",
                    color: focusedField === f.field ? '#3c8fc7' : 'var(--text-secondary)', transition: 'color 0.3s' }}>
                    {f.label} <span style={{ color: '#fcc93b' }}>*</span>
                  </label>
                  <input type={f.type || 'text'} className="input-field" value={formData[f.field]}
                    onChange={handleChange(f.field)} onFocus={() => setFocusedField(f.field)} onBlur={() => setFocusedField(null)}
                    style={errors[f.field] ? { borderColor: '#ef4444' } : {}} />
                  {errors[f.field] && <div style={{ color: '#ef4444', fontSize: 13, marginTop: 6 }}>{errors[f.field]}</div>}
                </div>
              ))}

              {/* V4.13: Honeypot field - invisible to humans, bots auto-fill it */}
              <div style={{ position: 'absolute', left: '-9999px', opacity: 0, height: 0, overflow: 'hidden' }} aria-hidden="true">
                <label htmlFor="website_url">Website</label>
                <input id="website_url" type="text" name="website_url" tabIndex={-1} autoComplete="off"
                  value={hpField} onChange={(e) => setHpField(e.target.value)} />
              </div>

              {/* Facility Type Selection - REQUIRED */}
              <div style={{ marginTop: 12 }}>
                <label style={{ display: 'block', marginBottom: 12, fontSize: 14, fontWeight: 600, fontFamily: "'Archivo'",
                  color: 'var(--text-secondary)' }}>
                  What type of practice are you? <span style={{ color: '#fcc93b' }}>*</span>
                </label>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 10 }}>
                  {facilityOptions.map(opt => (
                    <button key={opt.value} type="button" onClick={() => handleFacilitySelect(opt.value)}
                      style={{
                        padding: '14px 16px', borderRadius: 12, border: '2px solid',
                        borderColor: formData.facilityType === opt.value ? '#3c8fc7' : 'var(--border-subtle)',
                        background: formData.facilityType === opt.value
                          ? 'linear-gradient(135deg, rgba(60,143,199,0.15), rgba(60,143,199,0.05))'
                          : 'rgba(255,255,255,0.03)',
                        cursor: 'pointer', textAlign: 'left', transition: 'all 0.3s ease',
                        transform: formData.facilityType === opt.value ? 'scale(1.02)' : 'scale(1)'
                      }}>
                      <div style={{ fontWeight: 600, fontSize: 14, color: formData.facilityType === opt.value ? '#3c8fc7' : 'var(--text-primary)',
                        marginBottom: 4 }}>{opt.label}</div>
                      <div style={{ fontSize: 11, color: 'var(--text-tertiary)', lineHeight: 1.3 }}>{opt.desc}</div>
                    </button>
                  ))}
                </div>
                {errors.facilityType && <div style={{ color: '#ef4444', fontSize: 13, marginTop: 8 }}>{errors.facilityType}</div>}
              </div>

              {/* Financial context is collected via assessment questions (patient volume, monthly billing, AR days) */}

              <button className="btn-primary" onClick={handleSubmit} style={{ marginTop: 20, width: '100%' }}>
                Continue to Assessment
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 12, verticalAlign: 'middle' }}>
                  <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // QUESTION CARD - Epic transitions with V3 routing support
    // ============================================
    const QuestionCard = ({ question, answer, onAnswer, onNext, onBack, questionIndex, totalQuestions, isFirst, isLast, selectedSegment }) => {
      // V4.10: Defensive handling - ensure question exists
      if (!question) {
        console.error('QuestionCard received undefined question');
        return <div style={{ color: 'red', padding: 40 }}>Error: No question to display</div>;
      }
      const q = question;
      const isRoutingQuestion = q.isRoutingQuestion;

      // Helper to get the correct initial value based on question type
      // V4.10: Enhanced defensive handling for undefined defaults
      const getInitialValue = (ans, questionType, defaultVal, question) => {
        if (ans !== undefined) return ans;
        if (questionType === 'slider') return defaultVal !== undefined ? defaultVal : (question?.min || 0);
        if (questionType === 'number') return defaultVal !== undefined ? defaultVal : ''; // V4.9: Exact number input
        if (questionType === 'multi') return []; // Ensure multi-select starts with empty array
        // V4.12.2: Removed orphaned payer_mix default handling - question type removed in V4.11
        return undefined;
      };

      const [localValue, setLocalValue] = useState(() => getInitialValue(answer, q.type, q.default, q));
      const [phase, setPhase] = useState('entering'); // entering, visible, exiting
      const [direction, setDirection] = useState('forward');

      // V4.10: Use ref to track current answer prop without causing re-renders
      const answerRef = useRef(answer);
      answerRef.current = answer;

      useEffect(() => {
        // Reset local value when question changes, ensuring correct type
        // V4.10: Use answerRef.current to get latest answer without dependency issues
        const currentAnswer = answerRef.current;
        const newValue = getInitialValue(currentAnswer, q.type, q.default, q);
        setLocalValue(newValue);
        setPhase('entering');
        const timer = setTimeout(() => setPhase('visible'), 50);
        return () => clearTimeout(timer);
      }, [q.id]); // Only re-run when question ID changes

      const progress = ((questionIndex + 1) / totalQuestions) * 100;

      const isAnswered = () => {
        if (q.type === 'slider') return true;
        if (q.type === 'currency') return true; // V4.11: Currency slider always has a value
        if (q.type === 'number') return localValue !== undefined && localValue !== '' && localValue > 0; // V4.10: Any positive number
        if (q.type === 'single') return localValue !== undefined;
        if (q.type === 'multi') return localValue && localValue.length > 0;
        // V4.12.2: Removed orphaned payer_mix validation - question type removed in V4.11
        return false;
      };

      const handleNext = () => {
        onAnswer(q.id, localValue);
        setDirection('forward');
        setPhase('exiting');
        setTimeout(() => onNext(q.id, localValue), 400);
      };

      const handleBack = () => {
        setDirection('back');
        setPhase('exiting');
        setTimeout(() => onBack(), 400);
      };

      const getTransformStyle = () => {
        if (phase === 'entering') {
          return direction === 'forward'
            ? { opacity: 0, transform: 'translateX(100px) scale(0.95) rotateY(-5deg)' }
            : { opacity: 0, transform: 'translateX(-100px) scale(0.95) rotateY(5deg)' };
        }
        if (phase === 'exiting') {
          return direction === 'forward'
            ? { opacity: 0, transform: 'translateX(-100px) scale(0.95) rotateY(5deg)' }
            : { opacity: 0, transform: 'translateX(100px) scale(0.95) rotateY(-5deg)' };
        }
        return { opacity: 1, transform: 'translateX(0) scale(1) rotateY(0)' };
      };

      const getSliderColor = () => {
        if (!q.benchmark) return '#3c8fc7';
        // V4.10: Defensive handling for undefined localValue during transitions
        const safeValue = localValue !== undefined && localValue !== null ? localValue : (q.default || q.min || 0);
        const isInverted = q.id === 'ar_days';

        // V4.10: Use scoring function if available for accurate color representation
        // This ensures slider color matches the actual score interpretation
        if (q.scoring && typeof q.scoring === 'function') {
          const score = q.scoring(safeValue);
          if (score >= 80) return '#10b981'; // green - excellent
          if (score >= 60) return '#3c8fc7'; // blue - good
          if (score >= 40) return '#f59e0b'; // amber - fair
          return '#ef4444'; // red - needs improvement
        }

        // Fallback to benchmark-based calculation for questions without scoring
        const perf = isInverted
          ? (safeValue <= q.benchmark ? 100 : Math.max(0, 100 - ((safeValue - q.benchmark) / (q.max - q.benchmark)) * 100))
          : (safeValue / q.benchmark) * 100;
        if (perf >= 80) return '#10b981';
        if (perf >= 60) return '#3c8fc7';
        if (perf >= 40) return '#f59e0b';
        return '#ef4444';
      };

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', justifyContent: 'flex-start', padding: '80px 24px 24px', perspective: 1000, position: 'relative', zIndex: 2 }}>
          <div style={{ maxWidth: 780, width: '100%', margin: '0 auto' }}>
            {/* Header - FIXED POSITION, never moves vertically */}
            <div style={{
              display: 'flex', alignItems: 'center', justifyContent: 'space-between',
              marginBottom: 36,
              minHeight: 52  /* Fixed height to prevent jumping */
            }}>
              {/* V4.10: Handle routing questions, diagnostic questions (null categoryIndex), and scored questions */}
              {isRoutingQuestion || q.isDiagnostic ? (
                <div style={{
                  display: 'inline-flex', alignItems: 'center', gap: 10, padding: '10px 20px', borderRadius: 100,
                  background: q.isDiagnostic ? 'rgba(60,143,199,0.15)' : 'rgba(252,201,59,0.15)',
                  border: q.isDiagnostic ? '1px solid rgba(60,143,199,0.40)' : '1px solid rgba(252,201,59,0.40)',
                  transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
                }}>
                  <div style={{ width: 10, height: 10, borderRadius: '50%',
                    background: q.isDiagnostic ? '#3c8fc7' : '#fcc93b',
                    boxShadow: q.isDiagnostic ? '0 0 15px #3c8fc7' : '0 0 15px #fcc93b',
                    animation: 'pulse 2s infinite' }} />
                  <span style={{ fontSize: 13, fontWeight: 700, fontFamily: "'Archivo'",
                    color: q.isDiagnostic ? '#3c8fc7' : '#fcc93b',
                    letterSpacing: '0.5px', textTransform: 'uppercase' }}>
                    {q.isDiagnostic ? 'Context' : 'Get Started'}
                  </span>
                </div>
              ) : (
                <div style={{
                  display: 'inline-flex', alignItems: 'center', gap: 10, padding: '10px 20px', borderRadius: 100,
                  background: `${categoryColors[q.categoryIndex] || '#3c8fc7'}15`, border: `1px solid ${categoryColors[q.categoryIndex] || '#3c8fc7'}40`,
                  transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
                }}>
                  <div style={{ width: 10, height: 10, borderRadius: '50%', background: categoryColors[q.categoryIndex] || '#3c8fc7',
                    boxShadow: `0 0 15px ${categoryColors[q.categoryIndex] || '#3c8fc7'}`, animation: 'pulse 2s infinite',
                    transition: 'background 0.4s ease, box-shadow 0.4s ease' }} />
                  <span style={{ fontSize: 13, fontWeight: 700, fontFamily: "'Archivo'", color: categoryColors[q.categoryIndex] || '#3c8fc7',
                    letterSpacing: '0.5px', textTransform: 'uppercase', transition: 'color 0.4s ease' }}>{q.category}</span>
                </div>
              )}
              <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                <span style={{ fontSize: 15, color: 'var(--text-tertiary)', fontWeight: 600 }}>
                  <span style={{
                    color: '#3c8fc7',
                    display: 'inline-block',
                    minWidth: '1.2em',
                    textAlign: 'center',
                    transition: 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)'
                  }}>{questionIndex + 1}</span> of {totalQuestions}
                </span>
                <div style={{ width: 52, height: 52, transition: 'transform 0.3s ease' }}>
                  <ProgressRing progress={progress} size={52} strokeWidth={4} />
                </div>
              </div>
            </div>

            {/* Progress bar - FIXED POSITION, animated fill only */}
            {/* V4.10: Handle null categoryIndex for diagnostic questions */}
            <div style={{
              position: 'relative', height: 6, background: 'var(--bg-tertiary)', borderRadius: 3,
              marginBottom: 28, overflow: 'hidden'
            }}>
              <div style={{
                position: 'absolute', top: 0, left: 0, height: '100%', width: `${progress}%`,
                background: isRoutingQuestion || q.isDiagnostic
                  ? 'linear-gradient(90deg, #fcc93b, #3c8fc7)'
                  : `linear-gradient(90deg, ${categoryColors[0]}, ${categoryColors[q.categoryIndex] || categoryColors[0]})`,
                borderRadius: 3, transition: 'width 0.6s var(--ease-out-expo), background 0.4s ease',
                boxShadow: isRoutingQuestion || q.isDiagnostic ? '0 0 20px rgba(252,201,59,0.5)' : `0 0 20px ${categoryColors[q.categoryIndex] || categoryColors[0]}50`
              }} />
              <div style={{
                position: 'absolute', top: 0, left: 0, height: '100%', width: `${progress}%`,
                background: 'linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)',
                backgroundSize: '200% 100%', animation: 'shimmer 2s infinite', borderRadius: 3
              }} />
            </div>

            {/* Card - ANIMATED, slides in/out, expands based on content */}
            <div style={{
              ...getTransformStyle(),
              transition: 'all 0.5s cubic-bezier(0.16, 1, 0.3, 1)'
            }}>
              <div className="glass-card" style={{ padding: 56 }}>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 26, fontWeight: 700, marginBottom: 36, lineHeight: 1.4 }}>{q.question}</h2>

              {/* Slider */}
              {/* V4.10: Added defensive handling for undefined localValue during question transitions */}
              {q.type === 'slider' && (() => {
                const sliderValue = localValue !== undefined && localValue !== null ? localValue : (q.default || q.min || 0);
                const sliderProgress = ((sliderValue - q.min) / (q.max - q.min)) * 100;
                return (
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', marginBottom: 20 }}>
                    <div style={{ fontSize: 56, fontWeight: 800, fontFamily: "'Archivo'", color: getSliderColor(),
                      textShadow: `0 0 40px ${getSliderColor()}50`, transition: 'color 0.3s' }}>
                      {sliderValue}{q.unit}
                    </div>
                    {q.benchmark && <div style={{ fontSize: 14, color: 'var(--text-tertiary)', textAlign: 'right' }}>{q.benchmarkLabel}</div>}
                  </div>
                  <div style={{ position: 'relative', padding: '10px 0' }}>
                    <input type="range" min={q.min} max={q.max} value={sliderValue}
                      onChange={(e) => setLocalValue(parseInt(e.target.value))}
                      style={{ background: `linear-gradient(to right, ${getSliderColor()} 0%, ${getSliderColor()} ${sliderProgress}%, var(--bg-tertiary) ${sliderProgress}%, var(--bg-tertiary) 100%)` }} />
                    {q.benchmark && (
                      <div style={{ position: 'absolute', left: `${((q.benchmark - q.min) / (q.max - q.min)) * 100}%`, top: '100%', transform: 'translateX(-50%)', marginTop: 12 }}>
                        <div style={{ width: 2, height: 16, background: '#10b981', margin: '0 auto 6px', boxShadow: '0 0 10px #10b981' }} />
                        <div style={{ fontSize: 12, color: '#10b981', whiteSpace: 'nowrap', fontWeight: 700, fontFamily: "'Archivo'" }}>{q.benchmark}{q.unit}</div>
                      </div>
                    )}
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 13, color: 'var(--text-muted)', marginTop: q.benchmark ? 48 : 12 }}>
                    <span>{q.min}{q.unit}</span><span>{q.max}{q.unit}</span>
                  </div>
                </div>
                );
              })()}

              {/* V4.9: Number input - simple exact value entry */}
              {/* V4.10: Removed min/max constraints to allow any number, added onWheel blur to prevent scroll changing value */}
              {q.type === 'number' && (
                <div style={{ textAlign: 'center' }}>
                  <input
                    type="number"
                    value={localValue}
                    onChange={(e) => {
                      const val = e.target.value === '' ? '' : parseInt(e.target.value);
                      setLocalValue(val);
                    }}
                    onWheel={(e) => e.target.blur()}
                    style={{
                      width: 200, padding: '24px 32px', fontSize: 42, fontWeight: 800,
                      fontFamily: "'Archivo'", textAlign: 'center',
                      background: 'var(--bg-tertiary)', border: '2px solid var(--border-subtle)',
                      borderRadius: 16, color: '#3c8fc7', outline: 'none',
                      transition: 'border-color 0.2s, box-shadow 0.2s'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = '#3c8fc7';
                      e.target.style.boxShadow = '0 0 20px rgba(60,143,199,0.3)';
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = 'var(--border-subtle)';
                      e.target.style.boxShadow = 'none';
                    }}
                  />
                  {q.unit && (
                    <div style={{ fontSize: 16, fontWeight: 500, color: 'var(--text-secondary)', marginTop: 12 }}>{q.unit}</div>
                  )}
                </div>
              )}

              {/* Single select - with routing question support */}
              {q.type === 'single' && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: isRoutingQuestion ? 16 : 14 }}>
                  {q.options.map((opt, i) => {
                    // V4.9: Standardize on value-based storage for all single-select
                    // For routing: always use opt.value
                    // For regular: prefer opt.value if present, fallback to opt.label
                    const optionValue = opt.value || opt.label;
                    const isSelected = localValue === optionValue || localValue === opt.label; // Support legacy labels
                    const optColor = isRoutingQuestion && opt.value ? (segmentColors[opt.value] || '#3c8fc7') : '#3c8fc7';

                    return (
                      <div key={i} className={`option-card ${isSelected ? 'selected' : ''}`}
                        onClick={() => setLocalValue(optionValue)}
                        style={{
                          animation: `slideInRight 0.5s ease-out ${0.1 + i * 0.06}s both`,
                          padding: isRoutingQuestion ? '24px 28px' : '22px 28px',
                          borderColor: isSelected ? optColor : 'var(--border-subtle)',
                          background: isSelected ? `${optColor}15` : 'var(--bg-card)'
                        }}>
                        <div style={{
                          width: 26, height: 26, borderRadius: '50%',
                          border: `2px solid ${isSelected ? optColor : 'rgba(255,255,255,0.2)'}`,
                          background: isSelected ? `linear-gradient(135deg, ${optColor}, #072140)` : 'transparent',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          transition: 'all 0.4s var(--spring)', flexShrink: 0,
                          boxShadow: isSelected ? `0 0 20px ${optColor}40` : 'none'
                        }}>
                          {isSelected && <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#fff' }} />}
                        </div>
                        <div style={{ flex: 1 }}>
                          <span style={{ fontSize: 16, fontWeight: 600, display: 'block' }}>{opt.label}</span>
                          {opt.description && (
                            <span style={{ fontSize: 13, color: 'var(--text-tertiary)', display: 'block', marginTop: 6, lineHeight: 1.4 }}>
                              {opt.description}
                            </span>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* Multi select */}
              {q.type === 'multi' && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 14 }}>
                  {q.options.map((opt, i) => {
                    // Ensure localValue is always an array for multi-select
                    const safeLocalValue = Array.isArray(localValue) ? localValue : [];
                    // V4.9: Support value-based selection (for SNF payment methods) or label-based
                    const optionValue = opt.value || opt.label;
                    const selected = safeLocalValue.includes(optionValue);
                    const handleMultiClick = () => {
                      // Handle exclusive options (e.g., "Paper checks only")
                      if (opt.exclusive) {
                        // If clicking exclusive option, toggle it alone (clears all others)
                        setLocalValue(selected ? [] : [optionValue]);
                      } else {
                        // If clicking non-exclusive option
                        const exclusiveOpt = q.options.find(o => o.exclusive);
                        const exclusiveValue = exclusiveOpt ? (exclusiveOpt.value || exclusiveOpt.label) : null;
                        const currentValue = safeLocalValue;
                        // Remove any exclusive option that was selected
                        const filtered = exclusiveValue ? currentValue.filter(s => s !== exclusiveValue) : currentValue;
                        // Toggle the clicked option
                        setLocalValue(selected ? filtered.filter(s => s !== optionValue) : [...filtered, optionValue]);
                      }
                    };
                    return (
                      <div key={i} className={`option-card ${selected ? 'selected' : ''}`}
                        onClick={handleMultiClick}
                        style={{ animation: `slideInRight 0.5s ease-out ${0.1 + i * 0.06}s both` }}>
                        <div style={{
                          width: 26, height: 26, borderRadius: 8,
                          border: `2px solid ${selected ? '#3c8fc7' : 'rgba(255,255,255,0.2)'}`,
                          background: selected ? 'linear-gradient(135deg, #3c8fc7, #072140)' : 'transparent',
                          display: 'flex', alignItems: 'center', justifyContent: 'center', transition: 'all 0.4s var(--spring)', flexShrink: 0
                        }}>
                          {selected && <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M5 12l5 5L19 7" stroke="#fff" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/></svg>}
                        </div>
                        <span style={{ fontSize: 16, fontWeight: 500 }}>{opt.label}</span>
                        {/* V4.10: Removed points display - was confusing for users */}
                      </div>
                    );
                  })}
                  <div style={{ fontSize: 14, color: 'var(--text-muted)', marginTop: 10 }}>Select all that apply</div>
                </div>
              )}

              {/* V4.12.2: Removed orphaned payer_mix renderer - question type removed in V4.11 */}

              {/* V4.11: Currency input - slider only */}
              {q.type === 'currency' && (() => {
                const currencyValue = localValue !== undefined && localValue !== null ? localValue : (q.default || q.min || 0);
                const sliderProgress = ((currencyValue - q.min) / (q.max - q.min)) * 100;
                const formatCurrency = (val) => {
                  if (val >= 1000000) return `$${(val / 1000000).toFixed(1)}M`;
                  if (val >= 1000) return `$${(val / 1000).toFixed(0)}K`;
                  return `$${val.toLocaleString()}`;
                };
                return (
                  <div>
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'baseline', marginBottom: 32 }}>
                      <div style={{ fontSize: 64, fontWeight: 800, fontFamily: "'Archivo'", color: '#10b981',
                        textShadow: '0 0 40px rgba(16,185,129,0.4)', transition: 'all 0.3s' }}>
                        {formatCurrency(currencyValue)}
                      </div>
                      {q.unit && <div style={{ fontSize: 18, color: 'var(--text-secondary)', marginLeft: 12 }}>{q.unit}</div>}
                    </div>
                    <div style={{ position: 'relative', padding: '10px 0' }}>
                      <input type="range" min={q.min} max={q.max} step={q.step || 5000} value={currencyValue}
                        onChange={(e) => setLocalValue(parseInt(e.target.value))}
                        style={{ background: `linear-gradient(to right, #10b981 0%, #10b981 ${sliderProgress}%, var(--bg-tertiary) ${sliderProgress}%, var(--bg-tertiary) 100%)` }} />
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 13, color: 'var(--text-muted)', marginTop: 12 }}>
                      <span>{formatCurrency(q.min)}</span><span>{formatCurrency(q.max)}</span>
                    </div>
                  </div>
                );
              })()}

              {/* Navigation */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 48, paddingTop: 28, borderTop: '1px solid var(--border-subtle)' }}>
                {!isFirst ? (
                  <button className="btn-secondary" onClick={handleBack}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginRight: 10, verticalAlign: 'middle' }}>
                      <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>Back
                  </button>
                ) : <div />}
                <button className="btn-primary" onClick={handleNext}
                  style={{ opacity: isAnswered() ? 1 : 0.5, pointerEvents: isAnswered() ? 'auto' : 'none' }}>
                  {isLast ? 'Complete Assessment' : 'Continue'}
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 10, verticalAlign: 'middle' }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
            </div>{/* Close animated card wrapper */}
          </div>
        </div>
      );
    };

    // ============================================
    // COMPETITOR REFLECTIVE MODE (V4.14)
    // Infinite Personalization Loop - senior living focused
    // Only shown to competitor domain emails
    // ============================================
    const CompetitorBlockedScreen = () => {
      const [phase, setPhase] = useState('loading'); // loading, questions, transition, preview
      const [questionIndex, setQuestionIndex] = useState(0);
      const [answers, setAnswers] = useState({});
      const [currentAnswer, setCurrentAnswer] = useState('');
      const [progress, setProgress] = useState(42);
      const [flattery, setFlattery] = useState('');
      const [showFlattery, setShowFlattery] = useState(false);
      const [totalAnswered, setTotalAnswered] = useState(0);

      // Flattery messages that appear between questions
      const flatteryMessages = [
        "Excellent detail. This level of precision is rare.",
        "Most people rush this section. You didn't.",
        "Your responses show sophisticated market understanding.",
        "This kind of specificity helps us calibrate accurately.",
        "You're clearly thinking about this strategically.",
        "Impressive operational awareness.",
        "This depth of insight is uncommon.",
        "You're asking the kind of questions we built this for.",
        "Your attention to nuance is noted.",
        "Few respondents provide this level of clarity."
      ];

      // Phase 1: Baseline Calibration (ambulatory practice focused)
      const baselineQuestions = [
        {
          id: 'bl_1',
          question: "What best describes your practice's organizational structure?",
          subtext: "This helps us benchmark against similar practices",
          type: 'single',
          options: ['Solo practitioner', 'Small group (2-5 providers)', 'Mid-size group (6-20 providers)', 'Large group (20+ providers)', 'Health system employed']
        },
        {
          id: 'bl_2',
          question: "Approximately what percentage of your patients have high-deductible health plans?",
          subtext: "HDHP penetration varies significantly across practice types",
          type: 'slider',
          min: 5, max: 80, unit: '%'
        },
        {
          id: 'bl_3',
          question: "How would you characterize your current billing and payment technology stack?",
          subtext: "Understanding your infrastructure helps us tailor recommendations",
          type: 'single',
          options: ['Primarily manual/paper-based', 'Basic PM system with limited billing', 'Integrated EHR/PM with billing module', 'Dedicated RCM platform + EHR', 'Custom enterprise solution']
        },
        {
          id: 'bl_4',
          question: "What's your average days in A/R for patient responsibility balances?",
          subtext: "Industry benchmark is 30-40 days for high performers",
          type: 'slider',
          min: 10, max: 120, unit: ' days'
        },
        {
          id: 'bl_5',
          question: "How does your practice currently handle patient payment communications after insurance adjudication?",
          subtext: "This transition from insurance to patient responsibility often creates confusion",
          type: 'single',
          options: ['Largely manual process', 'Semi-automated with manual review', 'Mostly automated', 'Fully integrated workflow', 'We struggle with this']
        }
      ];

      // Phase 2: Precision Refinement (references earlier answers)
      const refinementQuestions = [
        {
          id: 'rf_1',
          question: "You indicated your billing approach earlier  how confident are you in that characterization?",
          subtext: "We want to ensure our benchmarking is accurate to your situation",
          type: 'single',
          options: ['Very confident - this is well documented', 'Fairly confident - based on my experience', 'Somewhat confident - may vary by location', 'Less confident - would need to verify', 'This varies significantly across our locations']
        },
        {
          id: 'rf_2',
          question: "When patients have billing questions, what's the typical resolution path?",
          subtext: "Understanding your workflow helps identify optimization opportunities",
          type: 'single',
          options: ['Direct to billing specialist', 'Through front desk staff', 'Call center/central billing', 'Self-service portal', 'Varies by inquiry type']
        },
        {
          id: 'rf_3',
          question: "How would you rate patient satisfaction with your current billing and payment experience?",
          subtext: "Perception gaps often reveal process improvement opportunities",
          type: 'slider',
          min: 1, max: 10, unit: '/10'
        },
        {
          id: 'rf_4',
          question: "What percentage of your billing staff time is spent on reactive inquiries vs. proactive denial management?",
          subtext: "This ratio often indicates revenue cycle maturity",
          type: 'slider',
          min: 10, max: 90, unit: '% reactive'
        },
        {
          id: 'rf_5',
          question: "If your patient collection rate improved by 15 percentage points, what would that mean for your practice?",
          subtext: "Understanding impact helps us prioritize recommendations",
          type: 'single',
          options: ['Marginal operational benefit', 'Noticeable improvement to cash flow', 'Significant strategic advantage', 'Transformational for our practice', 'Would need to calculate specific impact']
        }
      ];

      // Phase 3: Edge Case Validation (philosophical/interpretive)
      const edgeCaseQuestions = [
        {
          id: 'ec_1',
          question: "How do you think competing practices in your area handle patient billing compared to yours?",
          subtext: "Competitive positioning context helps calibrate your benchmark",
          type: 'single',
          options: ['They likely lag behind us', 'Roughly comparable', 'They may be slightly ahead', 'They\'re likely more advanced', 'Difficult to assess']
        },
        {
          id: 'ec_2',
          question: "If you could change one thing about your revenue cycle tomorrow, what area would have the highest impact?",
          subtext: "Prioritization insights help us focus recommendations",
          type: 'single',
          options: ['Payment method flexibility', 'Statement clarity/delivery', 'Patient portal capabilities', 'Denial management', 'Staff efficiency/automation', 'Point-of-service collection']
        },
        {
          id: 'ec_3',
          question: "How aligned is your leadership team on revenue cycle modernization priorities?",
          subtext: "Organizational readiness affects implementation success",
          type: 'slider',
          min: 1, max: 10, unit: '/10'
        },
        {
          id: 'ec_4',
          question: "What's the biggest misconception patients have about your billing process?",
          subtext: "Perception gaps often reveal communication opportunities",
          type: 'single',
          options: ['They think it\'s more complex than it is', 'They expect more payment flexibility', 'They don\'t understand what insurance covers', 'They assume we can provide instant cost estimates', 'They expect more digital/mobile options']
        },
        {
          id: 'ec_5',
          question: "When evaluating patient payment solutions, what would your leadership prioritize most?",
          subtext: "Stakeholder alignment is critical for successful initiatives",
          type: 'single',
          options: ['Cash flow acceleration', 'Cost reduction', 'Patient satisfaction', 'Staff productivity', 'Bad debt reduction', 'Integration simplicity']
        }
      ];

      // Phase 4: "Schedule Call" questions (the loop continues)
      const callPrepQuestions = [
        {
          id: 'cp_1',
          question: "To prepare for your personalized review, what specific challenges are you hoping to address?",
          subtext: "This helps our team prepare relevant insights",
          type: 'single',
          options: ['Reducing days in A/R', 'Improving patient payment experience', 'Reducing bad debt', 'Modernizing payment options', 'Reducing staff burden', 'All of the above']
        },
        {
          id: 'cp_2',
          question: "What's your timeline for evaluating patient payment solutions?",
          subtext: "Understanding urgency helps us prioritize appropriately",
          type: 'single',
          options: ['Actively evaluating now', 'Planning for next quarter', 'Exploring for next fiscal year', 'Early research phase', 'No specific timeline']
        },
        {
          id: 'cp_3',
          question: "Who else on your team would be involved in this evaluation?",
          subtext: "We want to ensure the right stakeholders receive relevant information",
          type: 'single',
          options: ['Just me initially', 'CFO/Finance leader', 'Operations/Practice Manager', 'IT/Technology team', 'Physician leadership', 'Cross-functional team']
        },
        {
          id: 'cp_4',
          question: "What patient payment solutions have you previously evaluated or implemented?",
          subtext: "Understanding your history helps us avoid redundant information",
          type: 'single',
          options: ['Haven\'t evaluated alternatives', 'Looked at options but didn\'t proceed', 'Implemented something that didn\'t work', 'Currently using a competitor solution', 'Built internal solutions', 'Prefer not to say']
        },
        {
          id: 'cp_5',
          question: "What would make this evaluation successful from your perspective?",
          subtext: "Defining success criteria helps us deliver relevant insights",
          type: 'single',
          options: ['Clear ROI projections', 'Implementation roadmap', 'Peer references/case studies', 'Technical integration details', 'Pricing transparency', 'All of the above']
        }
      ];

      // Deep calibration loop questions (infinite)
      const deepCalibrationQuestions = [
        {
          id: 'dc_1',
          question: "Earlier you mentioned your billing approach  has anything changed in the last 6 months?",
          subtext: "Recent changes may affect our benchmark accuracy",
          type: 'single',
          options: ['No significant changes', 'Minor process improvements', 'New technology implemented', 'Staff changes', 'Major strategic shift']
        },
        {
          id: 'dc_2',
          question: "How does your patient billing complexity vary between different payer types?",
          subtext: "Payer mix variation affects solution requirements",
          type: 'single',
          options: ['Minimal variation', 'Somewhat different', 'Significantly different', 'Completely different workflows', 'We standardize across all payers']
        },
        {
          id: 'dc_3',
          question: "What metrics does your practice track most closely for revenue cycle performance?",
          subtext: "Understanding your KPIs helps us align recommendations",
          type: 'single',
          options: ['Days in A/R', 'Collection rate', 'Denial rate', 'Clean claim rate', 'Bad debt percentage', 'Multiple metrics equally']
        },
        {
          id: 'dc_4',
          question: "How would you describe the relationship between your billing and clinical teams?",
          subtext: "Cross-functional dynamics affect implementation success",
          type: 'slider',
          min: 1, max: 10, unit: '/10 alignment'
        },
        {
          id: 'dc_5',
          question: "If we could provide one data point you don't currently have, what would be most valuable?",
          subtext: "Understanding visibility gaps helps us focus insights",
          type: 'single',
          options: ['Real-time collection forecasting', 'Patient payment behavior patterns', 'Staff productivity benchmarks', 'Competitive positioning data', 'Predictive bad debt analysis']
        },
        {
          id: 'dc_6',
          question: "How does your practice balance standardization vs. provider-level flexibility in patient billing?",
          subtext: "This tension affects solution architecture",
          type: 'single',
          options: ['Highly standardized', 'Mostly standardized with exceptions', 'Balanced approach', 'Mostly provider discretion', 'Fully decentralized']
        },
        {
          id: 'dc_7',
          question: "What's the most common reason patients give for late payments?",
          subtext: "Root cause patterns inform solution design",
          type: 'single',
          options: ['Confusion about amounts owed', 'Waiting for insurance to process', 'Limited payment options', 'Cash flow timing', 'Disputes about charges', 'We don\'t systematically track this']
        },
        {
          id: 'dc_8',
          question: "How has your patient payment approach evolved over the past 3 years?",
          subtext: "Trajectory context helps us understand organizational momentum",
          type: 'single',
          options: ['Largely unchanged', 'Incremental improvements', 'Significant modernization', 'Complete transformation', 'Actually regressed due to challenges']
        }
      ];

      // Combine all phases
      const allQuestions = [
        ...baselineQuestions,
        ...refinementQuestions,
        ...edgeCaseQuestions,
        ...callPrepQuestions,
        ...deepCalibrationQuestions
      ];

      // Get current question (loops through deep calibration infinitely)
      const getCurrentQuestion = () => {
        if (questionIndex < allQuestions.length) {
          return allQuestions[questionIndex];
        }
        // Loop through deep calibration questions infinitely
        const loopIndex = (questionIndex - allQuestions.length + deepCalibrationQuestions.length) % deepCalibrationQuestions.length;
        // Add variation to repeated questions
        const baseQ = deepCalibrationQuestions[loopIndex];
        return {
          ...baseQ,
          id: `${baseQ.id}_${Math.floor(questionIndex / deepCalibrationQuestions.length)}`,
          subtext: questionIndex > allQuestions.length + 8
            ? "Additional calibration needed for precise benchmarking"
            : baseQ.subtext
        };
      };

      // Calculate asymptotic progress (never reaches 100)
      const calculateProgress = (answered) => {
        // Starts at 42, approaches 99 but never reaches it
        // Formula: 42 + (57 * (1 - 1/(1 + answered*0.15)))
        const asymptote = 99;
        const start = 42;
        const range = asymptote - start;
        const calculated = start + (range * (1 - 1 / (1 + answered * 0.15)));
        return Math.min(98.7, calculated);
      };

      // Get phase label for progress bar
      const getPhaseLabel = () => {
        if (totalAnswered < 5) return "Baseline Calibration";
        if (totalAnswered < 10) return "Precision Refinement";
        if (totalAnswered < 15) return "Edge Case Validation";
        if (totalAnswered < 20) return "Insight Synthesis";
        if (totalAnswered < 25) return "Deep Calibration";
        return "Final Calibration";
      };

      // Initial loading simulation
      useEffect(() => {
        const timer = setTimeout(() => setPhase('questions'), 2500);
        return () => clearTimeout(timer);
      }, []);

      // Handle answer submission
      const handleNext = () => {
        if (!currentAnswer && getCurrentQuestion().type === 'single') return;

        const q = getCurrentQuestion();
        setAnswers(prev => ({ ...prev, [q.id]: currentAnswer }));
        setCurrentAnswer('');

        const newTotal = totalAnswered + 1;
        setTotalAnswered(newTotal);
        setProgress(calculateProgress(newTotal));

        // Show flattery every 3-4 questions
        if (newTotal > 0 && newTotal % (3 + Math.floor(Math.random() * 2)) === 0) {
          setPhase('transition');
          setFlattery(flatteryMessages[Math.floor(Math.random() * flatteryMessages.length)]);
          setShowFlattery(true);
          setTimeout(() => {
            setShowFlattery(false);
            setTimeout(() => {
              setPhase('questions');
              setQuestionIndex(prev => prev + 1);
            }, 300);
          }, 2500);
        } else if (newTotal === 20 || newTotal === 35 || newTotal === 50) {
          // Show "preview" at certain milestones, then continue
          setPhase('preview');
        } else {
          setQuestionIndex(prev => prev + 1);
        }
      };

      // Continue from preview (back into the loop)
      const handleContinueFromPreview = () => {
        setPhase('transition');
        setFlattery("Let's continue calibrating for maximum precision...");
        setShowFlattery(true);
        setTimeout(() => {
          setShowFlattery(false);
          setTimeout(() => {
            setPhase('questions');
            setQuestionIndex(prev => prev + 1);
          }, 300);
        }, 2000);
      };

      const currentQuestion = getCurrentQuestion();

      // Loading phase
      if (phase === 'loading') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
            <div className="glass-card" style={{ maxWidth: 500, width: '100%', padding: 60, textAlign: 'center', animation: 'scaleIn 0.6s var(--ease-out-expo)' }}>
              <div style={{ width: 64, height: 64, margin: '0 auto 32px', border: '3px solid var(--bg-tertiary)', borderTopColor: '#3c8fc7', borderRadius: '50%', animation: 'competitorSpin 1s linear infinite' }} />
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 24, fontWeight: 700, marginBottom: 12, color: '#fff' }}>Initializing Assessment</h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 15, lineHeight: 1.6 }}>Calibrating to your practice profile...</p>
            </div>
            <style>{`@keyframes competitorSpin { to { transform: rotate(360deg); } }`}</style>
          </div>
        );
      }

      // Transition/flattery phase
      if (phase === 'transition') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
            <div className="glass-card" style={{ maxWidth: 500, width: '100%', padding: 60, textAlign: 'center', animation: 'scaleIn 0.4s var(--ease-out-expo)' }}>
              <div style={{ fontSize: 48, marginBottom: 24 }}></div>
              <p style={{ color: '#fcc93b', fontSize: 18, fontWeight: 600, lineHeight: 1.6, opacity: showFlattery ? 1 : 0, transition: 'opacity 0.5s' }}>{flattery}</p>
            </div>
          </div>
        );
      }

      // Preview phase (vague non-result, then continues)
      if (phase === 'preview') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
            <div className="glass-card" style={{ maxWidth: 580, width: '100%', padding: 48, animation: 'scaleIn 0.6s var(--ease-out-expo)' }}>
              <div style={{ textAlign: 'center', marginBottom: 32 }}>
                <div style={{ fontSize: 48, marginBottom: 16 }}></div>
                <h2 style={{ fontFamily: "'Archivo'", fontSize: 26, fontWeight: 700, marginBottom: 12, color: '#fff' }}>Preliminary Insights</h2>
                <div style={{ background: 'var(--bg-tertiary)', borderRadius: 8, padding: '8px 16px', display: 'inline-block', marginBottom: 16 }}>
                  <span style={{ color: '#fcc93b', fontWeight: 600 }}>{progress.toFixed(1)}%</span>
                  <span style={{ color: 'var(--text-muted)', marginLeft: 8 }}>calibrated</span>
                </div>
              </div>

              <div style={{ background: 'rgba(60, 143, 199, 0.1)', border: '1px solid rgba(60, 143, 199, 0.2)', borderRadius: 12, padding: 24, marginBottom: 24 }}>
                <p style={{ color: 'var(--text-secondary)', fontSize: 15, lineHeight: 1.7, marginBottom: 16 }}>
                  Based on your responses, your practice demonstrates <span style={{ color: '#fff', fontWeight: 600 }}>above-average operational awareness</span> in patient billing operations.
                </p>
                <p style={{ color: 'var(--text-secondary)', fontSize: 15, lineHeight: 1.7, marginBottom: 0 }}>
                  To provide <span style={{ color: '#fcc93b' }}>precise, actionable benchmarks</span>, we need a bit more calibration data. Organizations at your level typically benefit from our deep-dive analysis.
                </p>
              </div>

              <div style={{ display: 'flex', gap: 12 }}>
                <button className="btn-primary" onClick={handleContinueFromPreview} style={{ flex: 1 }}>
                  Continue Calibration
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 10, verticalAlign: 'middle' }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </button>
              </div>
              <button onClick={handleContinueFromPreview} style={{ width: '100%', marginTop: 12, padding: '12px 24px', background: 'transparent', border: '1px solid var(--border-subtle)', borderRadius: 8, color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 14 }}>
                Schedule a call to discuss results
              </button>
            </div>
          </div>
        );
      }

      // Questions phase (main loop)
      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
          <div className="glass-card" style={{ maxWidth: 640, width: '100%', padding: 48, animation: 'scaleIn 0.5s var(--ease-out-expo)' }}>
            {/* Progress section */}
            <div style={{ marginBottom: 32 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                <span style={{ color: 'var(--text-muted)', fontSize: 13, fontWeight: 500 }}>{getPhaseLabel()}</span>
                <span style={{ color: '#fcc93b', fontSize: 13, fontWeight: 600 }}>{progress.toFixed(1)}% calibrated</span>
              </div>
              <div style={{ height: 6, background: 'var(--bg-tertiary)', borderRadius: 3, overflow: 'hidden' }}>
                <div style={{ height: '100%', background: 'linear-gradient(90deg, #3c8fc7, #fcc93b)', borderRadius: 3, width: `${progress}%`, transition: 'width 0.5s ease' }} />
              </div>
            </div>

            {/* Question */}
            <h2 style={{ fontFamily: "'Archivo'", fontSize: 22, fontWeight: 700, marginBottom: 12, color: '#fff', lineHeight: 1.4 }}>
              {currentQuestion.question}
            </h2>
            {currentQuestion.subtext && (
              <p style={{ color: 'var(--text-muted)', fontSize: 14, marginBottom: 28, lineHeight: 1.5 }}>{currentQuestion.subtext}</p>
            )}

            {/* Answer options */}
            {currentQuestion.type === 'single' && (
              <div style={{ display: 'flex', flexDirection: 'column', gap: 10, marginBottom: 32 }}>
                {currentQuestion.options.map((opt, i) => (
                  <button
                    key={i}
                    onClick={() => setCurrentAnswer(opt)}
                    style={{
                      padding: '14px 18px',
                      background: currentAnswer === opt ? 'rgba(60, 143, 199, 0.2)' : 'var(--bg-tertiary)',
                      border: currentAnswer === opt ? '2px solid #3c8fc7' : '2px solid transparent',
                      borderRadius: 10,
                      color: currentAnswer === opt ? '#fff' : 'var(--text-secondary)',
                      textAlign: 'left',
                      cursor: 'pointer',
                      fontSize: 15,
                      transition: 'all 0.2s ease'
                    }}
                  >
                    {opt}
                  </button>
                ))}
              </div>
            )}

            {currentQuestion.type === 'slider' && (
              <div style={{ marginBottom: 32 }}>
                <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'baseline', marginBottom: 24 }}>
                  <div style={{ fontSize: 48, fontWeight: 700, color: '#3c8fc7' }}>
                    {currentAnswer || currentQuestion.min || 50}
                  </div>
                  <div style={{ fontSize: 18, color: 'var(--text-secondary)', marginLeft: 8 }}>{currentQuestion.unit}</div>
                </div>
                <input
                  type="range"
                  min={currentQuestion.min || 0}
                  max={currentQuestion.max || 100}
                  value={currentAnswer || currentQuestion.min || 50}
                  onChange={(e) => setCurrentAnswer(parseInt(e.target.value))}
                  style={{ width: '100%' }}
                />
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 8, fontSize: 13, color: 'var(--text-muted)' }}>
                  <span>{currentQuestion.min}{currentQuestion.unit}</span>
                  <span>{currentQuestion.max}{currentQuestion.unit}</span>
                </div>
              </div>
            )}

            {/* Navigation */}
            <button
              className="btn-primary"
              onClick={handleNext}
              style={{ width: '100%', opacity: (currentAnswer || currentQuestion.type === 'slider') ? 1 : 0.5, pointerEvents: (currentAnswer || currentQuestion.type === 'slider') ? 'auto' : 'none' }}
            >
              Continue
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 10, verticalAlign: 'middle' }}>
                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      );
    };

    // ============================================
    // PROCESSING SCREEN
    // ============================================
    const ProcessingScreen = ({ onComplete }) => {
      const [progress, setProgress] = useState(0);
      const steps = ['Analyzing responses', 'Calculating scores', 'Comparing benchmarks', 'Generating insights'];
      const currentStep = Math.min(Math.floor(progress / 25), 3);

      useEffect(() => {
        const interval = setInterval(() => {
          setProgress(prev => {
            if (prev >= 100) { clearInterval(interval); setTimeout(onComplete, 600); return 100; }
            return prev + 1.5;
          });
        }, 40);
        return () => clearInterval(interval);
      }, []);

      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24, position: 'relative', zIndex: 2 }}>
          <div style={{ textAlign: 'center' }}>
            <div style={{ position: 'relative', width: 200, height: 200, margin: '0 auto 56px' }}>
              <div style={{
                position: 'absolute', inset: -20, borderRadius: '50%', border: '2px solid transparent',
                borderTopColor: '#3c8fc7', animation: 'rotateGradient 2s linear infinite'
              }} />
              <div style={{
                position: 'absolute', inset: 0, borderRadius: '50%',
                background: 'conic-gradient(from 0deg, #3c8fc7, #fcc93b, #5ba3d4, #3c8fc7)',
                animation: 'rotateGradient 3s linear infinite', opacity: 0.2, filter: 'blur(20px)'
              }} />
              <div style={{ position: 'absolute', inset: 20, borderRadius: '50%', background: 'var(--bg-primary)', boxShadow: 'inset 0 0 40px rgba(0,0,0,0.5)' }} />
              <svg style={{ position: 'absolute', inset: 0, transform: 'rotate(-90deg)' }} width="200" height="200">
                <defs>
                  <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#3c8fc7" /><stop offset="100%" stopColor="#fcc93b" />
                  </linearGradient>
                </defs>
                <circle cx="100" cy="100" r="90" fill="none" stroke="var(--bg-tertiary)" strokeWidth="6" />
                <circle cx="100" cy="100" r="90" fill="none" stroke="url(#loaderGrad)" strokeWidth="6" strokeLinecap="round"
                  strokeDasharray={565} strokeDashoffset={565 - (progress / 100) * 565} style={{ filter: 'drop-shadow(0 0 10px #3c8fc7)' }} />
              </svg>
              <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <span style={{ fontSize: 48, fontWeight: 800, fontFamily: "'Archivo'",
                  background: 'linear-gradient(135deg, #3c8fc7, #fcc93b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                  {Math.round(progress)}%
                </span>
              </div>
            </div>
            <div style={{ fontSize: 20, fontWeight: 600, fontFamily: "'Archivo'", marginBottom: 28 }}>{steps[currentStep]}</div>
            <div style={{ display: 'flex', justifyContent: 'center', gap: 10 }}>
              {steps.map((_, i) => (
                <div key={i} style={{
                  width: i <= currentStep ? 32 : 10, height: 10, borderRadius: 5,
                  background: i <= currentStep ? 'linear-gradient(135deg, #3c8fc7, #fcc93b)' : 'var(--bg-tertiary)',
                  transition: 'all 0.4s var(--ease-out-expo)'
                }} />
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // RESULTS JOURNEY V4.7 - Emotional arc experience
    // New flow: Context  Validation  Opportunity  Action  Vision  Next Steps
    // SNF uses 5 slides (combined improvements + vision)
    // ============================================
    const ResultsJourney = ({ scores, formData, answers }) => {
      const [currentSlide, setCurrentSlide] = useState(0);
      const [isTransitioning, setIsTransitioning] = useState(false);

      // V4.7: Calculate all derived data upfront
      const insights = calculateInsights(formData, answers);
      const visibleQuestions = getVisibleQuestions(answers);
      const gapAnalysis = getGapAnalysis(scores);
      const strengths = getStrengths(scores, answers);
      const recommendations = getActionableRecommendations(answers, scores, insights);
      const projections = calculatePatientPayProjections(answers, scores);
      const segment = answers['practice_type'];
      const benchmarks = industryBenchmarks[segment];

      // All segments use 3 categories and 7-slide flow
      const useTwoCategories = false;
      const totalSlides = 7;

      const goToSlide = (index) => {
        if (index === currentSlide || isTransitioning || index < 0 || index >= totalSlides) return;
        setIsTransitioning(true);
        setTimeout(() => { setCurrentSlide(index); setIsTransitioning(false); }, 400);
      };

      const goNext = () => goToSlide(currentSlide + 1);
      const goPrev = () => goToSlide(currentSlide - 1);

      // getScoreColor is imported from AssessmentEngine

      // Navigation buttons component
      const NavButtons = () => (
        <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 40, paddingTop: 24, borderTop: '1px solid var(--border-subtle)' }}>
          {currentSlide > 0 ? (
            <button className="btn-secondary" onClick={goPrev}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginRight: 8, verticalAlign: 'middle' }}>
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
              Previous
            </button>
          ) : <div />}
          {currentSlide < totalSlides - 1 ? (
            <button className="btn-primary" onClick={goNext}>
              Next
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 8, verticalAlign: 'middle' }}>
                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </button>
          ) : <div />}
        </div>
      );

      // Slide 0: Overview with Benchmark Comparison (V4.7)
      const OverviewSlide = () => {
        const segmentData = segment && facilityTypes[segment];
        const segmentColor = segment ? segmentColors[segment] : '#3c8fc7';
        const overallGap = gapAnalysis ? gapAnalysis.overall.gap : 0;
        const performance = gapAnalysis ? gapAnalysis.overall.performance : 'near';

        return (
          <div style={{ textAlign: 'center' }}>
            {/* Segment Badge */}
            {segmentData && (
              <div style={{
                display: 'inline-flex', alignItems: 'center', gap: 10, padding: '10px 24px', borderRadius: 100,
                background: `${segmentColor}15`, border: `1px solid ${segmentColor}40`, marginBottom: 20,
                animation: 'fadeInUp 0.6s ease-out both'
              }}>
                <div style={{ width: 10, height: 10, borderRadius: '50%', background: segmentColor, boxShadow: `0 0 10px ${segmentColor}` }} />
                <span style={{ fontSize: 14, fontWeight: 700, fontFamily: "'Archivo'", color: segmentColor }}>{segmentData.label}</span>
              </div>
            )}

            <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: 'var(--text-tertiary)', letterSpacing: 3, textTransform: 'uppercase', marginBottom: 18 }}>
              Assessment Complete
            </div>
            <h1 style={{ fontFamily: "'Archivo'", fontSize: 'clamp(36px, 5vw, 52px)', fontWeight: 800, marginBottom: 32,
              background: 'linear-gradient(135deg, #fff, #3c8fc7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
              Your Payment Readiness Score
            </h1>

            <div style={{ position: 'relative', width: 280, height: 280, margin: '0 auto 24px' }}>
              <div style={{ position: 'absolute', inset: -20, borderRadius: '50%', background: `radial-gradient(circle, ${getScoreColor(scores.overall, segment)}30 0%, transparent 70%)`,
                animation: 'celebratePulse 2s ease-in-out infinite' }} />
              <ProgressRing progress={scores.overall} size={280} strokeWidth={16} delay={300} />
              <div style={{ position: 'absolute', inset: 0, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                <div style={{ fontSize: 72, fontWeight: 800, fontFamily: "'Archivo'", color: getScoreColor(scores.overall, segment),
                  textShadow: `0 0 50px ${getScoreColor(scores.overall, segment)}50`, animation: 'numberPop 0.8s ease-out 0.5s both' }}>
                  <AnimatedNumber value={scores.overall} delay={500} />
                </div>
                <div style={{ fontSize: 20, fontFamily: "'Archivo'", color: getScoreColor(scores.overall, segment), fontWeight: 700 }}>
                  {getScoreLevel(scores.overall, segment)}
                </div>
              </div>
            </div>

            {/* V4.7: Benchmark Comparison */}
            {benchmarks && (
              <div style={{
                display: 'inline-flex', alignItems: 'center', gap: 12, padding: '12px 24px',
                background: overallGap >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)',
                border: `1px solid ${overallGap >= 0 ? 'rgba(16,185,129,0.3)' : 'rgba(245,158,11,0.3)'}`,
                borderRadius: 12, marginBottom: 32,
                animation: 'fadeInUp 0.6s ease-out 0.3s both'
              }}>
                <span style={{ fontSize: 15, color: 'var(--text-secondary)' }}>
                  You: <strong style={{ color: 'var(--text-primary)' }}>{scores.overall}</strong>
                </span>
                <span style={{ color: 'var(--text-muted)' }}>|</span>
                <span style={{ fontSize: 15, color: 'var(--text-secondary)' }}>
                  {benchmarks.label} Average: <strong style={{ color: 'var(--text-primary)' }}>{benchmarks.overall}</strong>
                </span>
                <span style={{
                  display: 'inline-flex', alignItems: 'center', gap: 4,
                  padding: '4px 10px', borderRadius: 100,
                  background: overallGap >= 0 ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)',
                  color: overallGap >= 0 ? '#10B981' : '#F59E0B',
                  fontSize: 13, fontWeight: 700
                }}>
                  {overallGap >= 0 ? (
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 15l-6-6-6 6" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
                  ) : (
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
                  )}
                  {overallGap >= 0 ? '+' : ''}{overallGap}
                </span>
              </div>
            )}

            {/* Segment context card - V4.12.2: SNF no longer shows Payer Mix (moved away from that input) */}
            {segmentData && (
              <div className="glass-card" style={{
                padding: 24, marginBottom: 32, textAlign: 'left',
                background: `${segmentColor}08`, border: `1px solid ${segmentColor}20`,
                animation: 'fadeInUp 0.6s ease-out 0.4s both'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: 16 }}>
                  {/* Payer mix context */}
                  {segment && (
                    <div>
                      <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 6 }}>Payer Mix</div>
                      <div style={{ fontSize: 15, color: 'var(--text-primary)', fontWeight: 600 }}>{segmentData.characteristics.payerMix}</div>
                    </div>
                  )}
                  <div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 6 }}>Typical AR Days</div>
                    <div style={{ fontSize: 15, color: 'var(--text-primary)', fontWeight: 600 }}>{segmentData.characteristics.arDaysRange}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 6 }}>Key Focus</div>
                    <div style={{ fontSize: 15, color: segmentColor, fontWeight: 600 }}>{segmentData.characteristics.keyFocus}</div>
                  </div>
                </div>
              </div>
            )}

            {/* V4.12.2: Removed SNF Patient Breakdown card - payer mix input was removed in V4.11 */}

            {/* Category scores with benchmark indicators */}
            {(() => {
              const segmentCategoryNames = categoryNames;
              const displayCategories = segmentCategoryNames;
              const gridCols = 'repeat(3, 1fr)';
              const displayWeights = scores.weights;
              const categoryBenchmarks = [benchmarks?.operations, benchmarks?.family, benchmarks?.competitive];

              return (
                <div style={{ display: 'grid', gridTemplateColumns: gridCols, gap: 20, marginBottom: 32 }}>
                  {displayCategories.map((name, i) => {
                    const weight = displayWeights ? Math.round(displayWeights[i] * 100) : 33;
                    const catBenchmark = categoryBenchmarks[i];
                    const catGap = catBenchmark ? scores.categories[i] - catBenchmark : 0;
                    return (
                      <div key={i} className="glass-card" style={{
                        padding: 28, animation: `fadeInUp 0.6s ease-out ${0.6 + i * 0.1}s both`,
                        background: `${categoryColors[i]}10`, border: `1px solid ${categoryColors[i]}30`
                      }}>
                        <div style={{ fontSize: 40, fontWeight: 800, fontFamily: "'Archivo'", color: categoryColors[i],
                          textShadow: `0 0 30px ${categoryColors[i]}50`, marginBottom: 8 }}>
                          <AnimatedNumber value={scores.categories[i]} delay={800 + i * 150} />
                        </div>
                        <div style={{ fontSize: 14, color: 'var(--text-secondary)', fontWeight: 600, marginBottom: 8 }}>{name}</div>
                        {/* Benchmark indicator */}
                        {catBenchmark && (
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, marginBottom: 4 }}>
                            <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>vs {catBenchmark} avg</span>
                            <span style={{
                              fontSize: 11, fontWeight: 700,
                              color: catGap >= 0 ? '#10B981' : '#F59E0B'
                            }}>
                              {catGap >= 0 ? '+' : ''}{catGap}
                            </span>
                          </div>
                        )}
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                          <div style={{ fontSize: 11, color: 'var(--text-muted)', padding: '2px 8px', background: 'rgba(255,255,255,0.05)', borderRadius: 100 }}>
                            {weight}% weight
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })()}
            <NavButtons />
          </div>
        );
      };

      // Slide 1: Your Strengths (V4.7 - NEW)
      const StrengthsSlide = () => {
        const segmentData = segment && facilityTypes[segment];
        const segmentColor = segment ? segmentColors[segment] : '#3c8fc7';

        return (
          <div>
            <div style={{ marginBottom: 40 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#10B981', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 12 }}>
                What You're Doing Well
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 36, fontWeight: 700, marginBottom: 12,
                background: 'linear-gradient(135deg, #10B981, #3c8fc7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Your Strengths
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 17, lineHeight: 1.6 }}>
                {strengths.summaryStatement}
              </p>
            </div>

            {/* Strong Categories */}
            {strengths.strongCategories.length > 0 && (
              <div style={{ marginBottom: 32 }}>
                <h3 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                  Categories Above Benchmark
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                  {strengths.strongCategories.map((cat, i) => (
                    <div key={cat.index} className="glass-card" style={{
                      padding: 24, animation: `slideInRight 0.5s ease-out ${i * 0.1}s both`,
                      background: 'rgba(16,185,129,0.08)', border: '1px solid rgba(16,185,129,0.25)',
                      display: 'flex', alignItems: 'center', gap: 20
                    }}>
                      <div style={{
                        width: 64, height: 64, borderRadius: 16,
                        background: `linear-gradient(135deg, ${cat.color}30, ${cat.color}10)`,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: cat.color
                      }}>
                        {cat.score}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 4 }}>{cat.name}</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                          <span style={{
                            padding: '4px 12px', borderRadius: 100, fontSize: 12, fontWeight: 700,
                            background: 'rgba(16,185,129,0.2)', color: '#10B981'
                          }}>
                            +{cat.gap} vs benchmark
                          </span>
                          <span style={{ fontSize: 14, color: '#10B981', fontWeight: 600 }}>{cat.celebrationText}</span>
                        </div>
                      </div>
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        <path d="M22 4L12 14.01l-3-3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Strong Questions */}
            {strengths.strongQuestions.length > 0 && (
              <div>
                <h3 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                  High-Scoring Areas
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                  {strengths.strongQuestions.map((q, i) => (
                    <div key={q.id} className="glass-card" style={{
                      padding: 20, animation: `fadeInUp 0.4s ease-out ${0.3 + i * 0.08}s both`,
                      display: 'flex', alignItems: 'center', gap: 16
                    }}>
                      <div style={{
                        width: 48, height: 48, borderRadius: 12, flexShrink: 0,
                        background: `linear-gradient(135deg, ${categoryColors[q.categoryIndex]}30, ${categoryColors[q.categoryIndex]}10)`,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 18, fontWeight: 800, fontFamily: "'Archivo'", color: categoryColors[q.categoryIndex]
                      }}>
                        {q.score}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 4, color: 'var(--text-primary)' }}>{q.question}</div>
                        <div style={{ fontSize: 13, color: 'var(--text-tertiary)' }}>
                          {Array.isArray(q.answer) ? q.answer.join(', ') : q.answer}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Fallback for early journey users - show relative strengths */}
            {!strengths.hasStrengths && strengths.isEarlyJourney && (
              <div>
                {/* Relative Strength - Closest to benchmark */}
                {strengths.relativeStrength && (
                  <div style={{ marginBottom: 24 }}>
                    <h3 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                      Your Strongest Area
                    </h3>
                    <div className="glass-card" style={{
                      padding: 24, animation: 'slideInRight 0.5s ease-out',
                      background: `rgba(60,143,199,0.08)`, border: `1px solid ${strengths.relativeStrength.color}30`,
                      display: 'flex', alignItems: 'center', gap: 20
                    }}>
                      <div style={{
                        width: 64, height: 64, borderRadius: 16,
                        background: `linear-gradient(135deg, ${strengths.relativeStrength.color}30, ${strengths.relativeStrength.color}10)`,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: strengths.relativeStrength.color
                      }}>
                        {strengths.relativeStrength.score}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 4 }}>{strengths.relativeStrength.name}</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                          <span style={{
                            padding: '4px 12px', borderRadius: 100, fontSize: 12, fontWeight: 700,
                            background: 'rgba(60,143,199,0.2)', color: '#3c8fc7'
                          }}>
                            {Math.abs(strengths.relativeStrength.gap)} points to benchmark
                          </span>
                          <span style={{ fontSize: 14, color: 'var(--text-secondary)' }}>Closest to target</span>
                        </div>
                      </div>
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" style={{ color: strengths.relativeStrength.color }}>
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    </div>
                  </div>
                )}

                {/* Moderate Questions - Things they're doing okay */}
                {strengths.moderateQuestions.length > 0 && (
                  <div style={{ marginBottom: 24 }}>
                    <h3 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                      Building Blocks in Place
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                      {strengths.moderateQuestions.map((q, i) => (
                        <div key={q.id} className="glass-card" style={{
                          padding: 20, animation: `fadeInUp 0.4s ease-out ${0.3 + i * 0.08}s both`,
                          display: 'flex', alignItems: 'center', gap: 16
                        }}>
                          <div style={{
                            width: 48, height: 48, borderRadius: 12, flexShrink: 0,
                            background: `linear-gradient(135deg, ${categoryColors[q.categoryIndex]}30, ${categoryColors[q.categoryIndex]}10)`,
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            fontSize: 18, fontWeight: 800, fontFamily: "'Archivo'", color: categoryColors[q.categoryIndex]
                          }}>
                            {q.score}
                          </div>
                          <div style={{ flex: 1 }}>
                            <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 4, color: 'var(--text-primary)' }}>{q.question}</div>
                            <div style={{ fontSize: 13, color: 'var(--text-tertiary)' }}>
                              {Array.isArray(q.answer) ? q.answer.join(', ') : q.answer}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Encouraging message */}
                <div className="glass-card" style={{
                  padding: 24, textAlign: 'center',
                  background: 'linear-gradient(135deg, rgba(60,143,199,0.08), rgba(16,185,129,0.05))',
                  border: '1px solid rgba(60,143,199,0.2)'
                }}>
                  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" style={{ color: '#3c8fc7', marginBottom: 12 }}>
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <h3 style={{ fontFamily: "'Archivo'", fontSize: 18, fontWeight: 700, marginBottom: 8 }}>Strong Foundation for Growth</h3>
                  <p style={{ color: 'var(--text-secondary)', fontSize: 14, lineHeight: 1.6, maxWidth: 480, margin: '0 auto' }}>
                    Being early in your modernization journey means you'll see substantial gains from optimizing your payment operations. Let's look at where to focus first.
                  </p>
                </div>
              </div>
            )}

            {/* V4.12.2: "What Families Are Choosing" moved to its own slide (MarketContextSlide) */}

            <NavButtons />
          </div>
        );
      };

      // V4.12.2: NEW Slide 2 - Market Context (non-SNF only)
      // "What Today's Families Expect" - moved from StrengthsSlide to its own dedicated slide
      const MarketContextSlide = () => {
        return (
          <div>
            <div style={{ marginBottom: 32 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#3c8fc7', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 10 }}>
                Market Context
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 32, fontWeight: 700, marginBottom: 10,
                background: 'linear-gradient(135deg, #3c8fc7, #fcc93b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                What Patients Expect
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 15, lineHeight: 1.6, maxWidth: 560 }}>
                Your patients live in a digital-first world  and their expectations for healthcare billing are catching up fast.
              </p>
            </div>

            {/* Hero Stat Card */}
            <div className="glass-card stat-card" style={{
              padding: 36,
              textAlign: 'center',
              background: 'linear-gradient(135deg, rgba(252,201,59,0.15), rgba(252,201,59,0.05))',
              border: '2px solid rgba(252,201,59,0.35)',
              marginBottom: 20,
              animation: 'fadeInUp 0.5s ease-out 0.1s both'
            }}>
              <div style={{
                fontSize: 72,
                fontWeight: 800,
                fontFamily: "'Archivo'",
                color: '#fcc93b',
                lineHeight: 1,
                marginBottom: 12,
                textShadow: '0 0 60px rgba(252,201,59,0.4)',
                animation: 'statPop 0.6s ease-out 0.3s both'
              }}>56%</div>
              <div style={{ fontSize: 18, color: 'var(--text-primary)', fontWeight: 600, marginBottom: 6 }}>
                of patients would switch providers
              </div>
              <div style={{ fontSize: 14, color: 'var(--text-muted)' }}>
                after a poor billing experience  74% of patients under 26
              </div>
            </div>

            {/* Supporting Stats */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16, marginBottom: 24 }}>
              <div className="glass-card stat-card" style={{
                padding: 24,
                textAlign: 'center',
                background: 'linear-gradient(135deg, rgba(60,143,199,0.12), rgba(60,143,199,0.04))',
                border: '1px solid rgba(60,143,199,0.25)',
                animation: 'fadeInUp 0.5s ease-out 0.2s both'
              }}>
                <div style={{
                  fontSize: 44,
                  fontWeight: 800,
                  fontFamily: "'Archivo'",
                  color: '#3c8fc7',
                  lineHeight: 1,
                  marginBottom: 8,
                  animation: 'statPop 0.5s ease-out 0.4s both'
                }}>33%</div>
                <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.4 }}>
                  of workers now on HDHPs (up from 27% in just one year)
                </div>
              </div>

              <div className="glass-card stat-card" style={{
                padding: 24,
                textAlign: 'center',
                background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.04))',
                border: '1px solid rgba(16,185,129,0.25)',
                animation: 'fadeInUp 0.5s ease-out 0.3s both'
              }}>
                <div style={{
                  fontSize: 44,
                  fontWeight: 800,
                  fontFamily: "'Archivo'",
                  color: '#10B981',
                  lineHeight: 1,
                  marginBottom: 8,
                  animation: 'statPop 0.5s ease-out 0.5s both'
                }}>92%</div>
                <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.4 }}>
                  of consumers already use digital payments
                </div>
              </div>
            </div>

            {/* Additional Context Stats */}
            <div className="glass-card" style={{
              padding: 20,
              marginBottom: 24,
              animation: 'fadeInUp 0.5s ease-out 0.4s both'
            }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                <div style={{ textAlign: 'center' }}>
                  <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#8B5CF6', marginBottom: 4 }}>77%</div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.3 }}>want payment plans for unexpected bills</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#3c8fc7', marginBottom: 4 }}>37%</div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.3 }}>missed bills due to complex payment systems</div>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981', marginBottom: 4 }}>73%</div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.3 }}>want retail-like convenience in healthcare</div>
                </div>
              </div>
            </div>

            {/* Bottom insight - opportunity framing */}
            <div className="glass-card" style={{
              padding: 24,
              background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06))',
              border: '1px solid rgba(16,185,129,0.30)',
              textAlign: 'center',
              animation: 'fadeInUp 0.5s ease-out 0.5s both'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 12, marginBottom: 12 }}>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  <path d="M22 4L12 14.01l-3-3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                <span style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 700, color: '#10B981' }}>
                  The Opportunity
                </span>
              </div>
              <p style={{ fontSize: 15, color: 'var(--text-primary)', lineHeight: 1.6, maxWidth: 500, margin: '0 auto' }}>
                Early adopters are already capturing this demand. <strong style={{ color: '#10B981' }}>Your window is open.</strong>
              </p>
              <p style={{ fontSize: 13, color: 'var(--text-muted)', marginTop: 12 }}>
                68% of providers are struggling to implement flexible payment solutions. The practices that move first win.
              </p>
            </div>

            <NavButtons />
          </div>
        );
      };

      // Slide 3 (was 2): Your Opportunities (V4.7 - Refactored from Gaps)
      const OpportunitiesSlide = () => {
        // Get categories below benchmark, ordered by category index (Ops  Family  Competitive)
        const opportunityCategories = gapAnalysis ? gapAnalysis.categories
          .filter(c => c.gap < 0)
          .sort((a, b) => a.index - b.index) // Order: 0 (Ops), 1 (Family), 2 (Competitive)
          : [];

        // Find the category with biggest gap for the summary statement
        const biggestGapCategory = opportunityCategories.length > 0
          ? [...opportunityCategories].sort((a, b) => a.gap - b.gap)[0]
          : null;

        return (
          <div>
            <div style={{ marginBottom: 40 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#F59E0B', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 12 }}>
                Where You Can Grow
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 36, fontWeight: 700, marginBottom: 12,
                background: 'linear-gradient(135deg, #F59E0B, #fcc93b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Your Opportunities
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 17, lineHeight: 1.6 }}>
                {biggestGapCategory
                  ? `Your biggest opportunity is in ${biggestGapCategory.name}, where you're ${Math.abs(biggestGapCategory.gap)} points below the industry benchmark.`
                  : 'You\'re meeting or exceeding benchmarks. Focus on optimization and staying ahead.'}
              </p>
            </div>

            {/* Opportunity Categories - ordered Ops  Family  Competitive */}
            {opportunityCategories.length > 0 && (
              <div style={{ marginBottom: 32 }}>
                <h3 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                  Categories Below Benchmark
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                  {opportunityCategories.map((cat, i) => (
                    <div key={cat.index} className="glass-card" style={{
                      padding: 24, animation: `slideInRight 0.5s ease-out ${i * 0.1}s both`,
                      background: 'rgba(245,158,11,0.08)', border: '1px solid rgba(245,158,11,0.25)',
                      display: 'flex', alignItems: 'center', gap: 20
                    }}>
                      <div style={{
                        width: 64, height: 64, borderRadius: 16,
                        background: `linear-gradient(135deg, ${categoryColors[cat.index]}30, ${categoryColors[cat.index]}10)`,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: categoryColors[cat.index]
                      }}>
                        {cat.score}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 4 }}>{cat.name}</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                          <span style={{
                            padding: '4px 12px', borderRadius: 100, fontSize: 12, fontWeight: 700,
                            background: 'rgba(245,158,11,0.2)', color: '#F59E0B'
                          }}>
                            {cat.gap} vs benchmark ({cat.benchmark})
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Financial Opportunity Summary */}
            {insights && insights.totalFinancialOpportunity > 0 && (
              <div className="glass-card" style={{
                padding: 32, marginBottom: 28,
                background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(60,143,199,0.08))',
                border: '1px solid rgba(16,185,129,0.4)'
              }}>
                <div style={{ fontSize: 13, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 8, textAlign: 'center' }}>
                  Your Annual Patient Billing
                </div>
                <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'Archivo'", color: '#3c8fc7', textAlign: 'center', marginBottom: 24 }}>
                  ${insights.annualBilling?.toLocaleString()}<span style={{ fontSize: 20, fontWeight: 500, color: 'var(--text-secondary)' }}>/year</span>
                </div>

                {/* Current State */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 24 }}>
                  <div style={{ textAlign: 'center', padding: 20, background: 'rgba(239,68,68,0.1)', borderRadius: 12, border: '1px solid rgba(239,68,68,0.2)' }}>
                    <div style={{ fontSize: 32, fontWeight: 800, fontFamily: "'Archivo'", color: '#EF4444' }}>
                      ${insights.cashInAR?.toLocaleString()}
                    </div>
                    <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginTop: 4 }}>Cash stuck in A/R</div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>
                      {insights.arDays} days to collect
                    </div>
                  </div>
                  <div style={{ textAlign: 'center', padding: 20, background: 'rgba(245,158,11,0.1)', borderRadius: 12, border: '1px solid rgba(245,158,11,0.2)' }}>
                    <div style={{ fontSize: 32, fontWeight: 800, fontFamily: "'Archivo'", color: '#F59E0B' }}>
                      ${insights.currentBadDebt?.toLocaleString()}
                    </div>
                    <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginTop: 4 }}>Annual bad debt risk</div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>
                      Based on industry rates
                    </div>
                  </div>
                </div>

                {/* With PatientPay */}
                <div style={{ padding: 24, background: 'rgba(16,185,129,0.15)', borderRadius: 16, border: '1px solid rgba(16,185,129,0.4)' }}>
                  <div style={{ fontSize: 12, color: '#10B981', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 16, textAlign: 'center', fontWeight: 700 }}>
                    With PatientPay (Annual)
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 24, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981' }}>
                        ${insights.cashFreedByARReduction?.toLocaleString()}
                      </div>
                      <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Cash freed annually</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 24, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981' }}>
                        {insights.arDays}  {insights.projectedARDays}
                      </div>
                      <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>AR days (47% faster)</div>
                    </div>
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 24, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981' }}>
                        ${insights.badDebtSavings?.toLocaleString()}
                      </div>
                      <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Bad debt saved/year</div>
                    </div>
                  </div>
                  <div style={{ textAlign: 'center', paddingTop: 16, borderTop: '1px solid rgba(16,185,129,0.3)' }}>
                    <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginBottom: 4 }}>Total Annual Impact</div>
                    <div style={{ fontSize: 42, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981', textShadow: '0 0 30px rgba(16,185,129,0.4)' }}>
                      ${insights.totalFinancialOpportunity?.toLocaleString()}+
                    </div>
                    <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 8 }}>
                      Based on PatientPay customer results: 47% AR reduction, 40% bad debt reduction
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Additional Financial Opportunities (card fees, autopay, etc.) */}
            {insights && (insights.autopayOpportunity > 0 || insights.annualCardFeesAbsorbed > 0) && (
              <div className="glass-card" style={{
                padding: 28, marginBottom: 28,
                background: 'linear-gradient(135deg, rgba(16,185,129,0.1), rgba(60,143,199,0.08))',
                border: '1px solid rgba(16,185,129,0.3)'
              }}>
                <div style={{ fontSize: 13, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 16, textAlign: 'center' }}>
                  Financial Opportunity
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: insights.annualCardFeesAbsorbed > 0 ? '1fr 1fr' : '1fr', gap: 24 }}>
                  {/* Cash flow improvement */}
                  {(insights.potentialFreedCash > 0 || insights.cashFreedByAutopay > 0) && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 36, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981', marginBottom: 4 }}>
                        ${((insights.potentialFreedCash || 0) + (insights.cashFreedByAutopay || 0)).toLocaleString()}
                      </div>
                      <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginBottom: 4 }}>
                        Cash tied up in A/R
                      </div>
                      <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>
                        Based on {insights.arDays} days in A/R vs. {insights.targetArDays}-day industry target
                      </div>
                    </div>
                  )}
                  {/* Credit card fees absorbed */}
                  {insights.annualCardFeesAbsorbed > 0 && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 36, fontWeight: 800, fontFamily: "'Archivo'", color: '#F59E0B', marginBottom: 4 }}>
                        ${insights.annualCardFeesAbsorbed.toLocaleString()}
                      </div>
                      <div style={{ fontSize: 14, color: 'var(--text-secondary)' }}>
                        Annual card fees absorbed
                      </div>
                      <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>
                        PatientPay's convenience fee pass-through eliminates this cost
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Transition heading to next slide */}
            <div style={{ marginTop: 32, textAlign: 'center' }}>
              <h3 style={{
                fontFamily: "'Archivo'", fontSize: 20, fontWeight: 600,
                color: 'var(--text-secondary)', letterSpacing: 0.5,
                display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10
              }}>
                Here's how to close these gaps
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style={{ color: '#3c8fc7' }}>
                  <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </h3>
            </div>

            <NavButtons />
          </div>
        );
      };

      // Slides for old category details (kept for reference but not used in new flow)
      const CategorySlide = ({ categoryIndex }) => {
        // V4.4: Include questions that contribute to this category via categoryWeights (cross-category scoring)
        // A question contributes to this category if:
        // 1. Its primary categoryIndex matches this category, OR
        // 2. It has categoryWeights with an entry for this categoryIndex
        const categoryQuestions = visibleQuestions.filter(q => {
          if (q.isRoutingQuestion || q.isDiagnostic) return false;
          // Primary category match
          if (q.categoryIndex === categoryIndex) return true;
          // Cross-category: check categoryWeights array
          if (q.categoryWeights) {
            return q.categoryWeights.some(cw => cw.index === categoryIndex);
          }
          return false;
        });
        const score = scores.categories[categoryIndex];
        const segment = scores.segment;
        const weight = scores.weights ? Math.round(scores.weights[categoryIndex] * 100) : 33;

        return (
          <div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 20, marginBottom: 40 }}>
              <div style={{ width: 100, height: 100, position: 'relative' }}>
                <ProgressRing progress={score} size={100} strokeWidth={8} />
                <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center',
                  fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: categoryColors[categoryIndex] }}>
                  {score}
                </div>
              </div>
              <div>
                <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 8 }}>
                  Category Score ({weight}% of overall)
                </div>
                <h2 style={{ fontFamily: "'Archivo'", fontSize: 32, fontWeight: 700, color: categoryColors[categoryIndex], marginBottom: 4 }}>
                  {getCategoryName(categoryIndex, answers['practice_type'])}
                </h2>
                <div style={{ fontSize: 16, color: getScoreColor(score, segment), fontWeight: 600 }}>{getScoreLevel(score, segment)}</div>
              </div>
            </div>

            {/* Personalized insight for category 0 (Operational) */}
            {categoryIndex === 0 && insights && (
              <div className="glass-card" style={{ padding: 28, marginBottom: 32, background: 'rgba(252,201,59,0.08)', border: '1px solid rgba(252,201,59,0.2)' }}>
                <div style={{ fontSize: 13, fontFamily: "'Archivo'", color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 12 }}>
                  Your Numbers
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: insights.potentialFreedCash > 0 ? '1fr 1fr' : '1fr', gap: 20 }}>
                  <div>
                    <div style={{ fontSize: 36, fontWeight: 800, fontFamily: "'Archivo'", color: '#fcc93b', marginBottom: 8 }}>
                      ${insights.cashInAR.toLocaleString()}
                    </div>
                    <div style={{ fontSize: 15, color: 'var(--text-secondary)' }}>Cash tied up in receivables ({insights.arDays} days)</div>
                  </div>
                  {insights.potentialFreedCash > 0 && (
                    <div style={{ padding: 16, background: 'rgba(16,185,129,0.1)', borderRadius: 12 }}>
                      <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#10b981', marginBottom: 4 }}>
                        ${insights.potentialFreedCash.toLocaleString()}
                      </div>
                      <div style={{ fontSize: 13, color: '#10b981' }}>Potential to free by reducing to {insights.targetArDays} days</div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* V4.14: Enhanced Multi-Guarantor Opportunity Display */}
            {/* V4.6: Use "patient" for SNF, "resident" for others */}
            {categoryIndex === 1 && insights && insights.totalPayers > 0 && (() => {
              const personTerm = 'patient';
              const personTermPlural = 'Patients';
              const avgPayers = insights.avgPayersPerResident || 2;
              const complexityMultiplier = avgPayers.toFixed(1);
              return (
              <div className="glass-card" style={{ padding: 28, marginBottom: 32, background: 'rgba(139,92,246,0.08)', border: '1px solid rgba(139,92,246,0.2)' }}>
                <div style={{ fontSize: 13, fontFamily: "'Archivo'", color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 16 }}>
                  Billing Complexity Multiplier
                </div>

                {/* Main stat row */}
                <div style={{ display: 'flex', alignItems: 'center', gap: 24, marginBottom: 20 }}>
                  {/* Visual: person icons showing multiplier */}
                  <div style={{ display: 'flex', gap: 4, flexShrink: 0 }}>
                    {Array.from({ length: Math.min(avgPayers, 8) }).map((_, i) => (
                      <svg key={i} width="28" height="28" viewBox="0 0 24 24" fill="none" style={{ opacity: 0.7 + (i === 0 ? 0.3 : 0) }}>
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke={i === 0 ? '#8B5CF6' : '#3c8fc7'} strokeWidth="2" strokeLinecap="round"/>
                        <circle cx="12" cy="7" r="4" stroke={i === 0 ? '#8B5CF6' : '#3c8fc7'} strokeWidth="2"/>
                      </svg>
                    ))}
                  </div>
                  <div>
                    <div style={{ fontSize: 14, color: 'var(--text-secondary)', lineHeight: 1.5 }}>
                      Each {personTerm} generates <span style={{ color: '#8B5CF6', fontWeight: 700, fontSize: 16 }}>{avgPayers}</span> billing relationships
                    </div>
                  </div>
                </div>

                {/* Key metrics grid */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 16 }}>
                  <div style={{ textAlign: 'center', padding: '16px 8px', background: 'rgba(139,92,246,0.1)', borderRadius: 10 }}>
                    <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#8B5CF6' }}>
                      {complexityMultiplier}x
                    </div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>Complexity vs. single payer</div>
                  </div>
                  <div style={{ textAlign: 'center', padding: '16px 8px', background: 'rgba(60,143,199,0.1)', borderRadius: 10 }}>
                    <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#3c8fc7' }}>
                      {insights.totalPayers}
                    </div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>Total family payers</div>
                  </div>
                  <div style={{ textAlign: 'center', padding: '16px 8px', background: 'rgba(16,185,129,0.1)', borderRadius: 10 }}>
                    <div style={{ fontSize: 28, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981' }}>
                      {insights.multiGuarantorResidents}
                    </div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>{personTermPlural} with split billing</div>
                  </div>
                </div>

                {/* Impact callout */}
                {insights.inquiryCost > 0 && (
                  <div style={{ padding: 14, background: 'rgba(252,201,59,0.08)', borderRadius: 8, borderLeft: '3px solid #fcc93b' }}>
                    <div style={{ fontSize: 14, color: 'var(--text-secondary)', lineHeight: 1.5 }}>
                      <span style={{ color: '#fcc93b', fontWeight: 600 }}>${insights.inquiryCost.toLocaleString()}/year</span> estimated cost of billing inquiries  {avgPayers > 2
                        ? 'with ' + avgPayers + ' payers per ' + personTerm + ', each billing cycle generates multiple coordination touchpoints'
                        : 'individual statements and self-service access could reduce this by 60-70%'}
                    </div>
                  </div>
                )}
              </div>
              );
            })()}

            <h3 style={{ fontFamily: "'Archivo'", fontSize: 18, fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 20 }}>
              Question Breakdown
            </h3>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
              {categoryQuestions.map((q, i) => {
                const answer = answers[q.id];
                if (answer === undefined) return null;

                let qScore = 0;
                if (q.type === 'slider' && q.scoring) qScore = q.scoring(answer);
                else if (q.type === 'single') {
                  const opt = q.options.find(o => o.label === answer || o.value === answer);
                  qScore = opt ? (opt.score || 0) : 0;
                }
                else if (q.type === 'multi') qScore = Math.min((answer || []).reduce((s, l) => { const o = q.options.find(x => x.label === l); return s + (o ? o.score : 0); }, 0), q.maxScore || 100);

                // V4.4: Check if this is a cross-category question and get weight for THIS category
                const isCrossCategory = q.categoryWeights && q.categoryWeights.length > 1;
                let thisCategoryWeight = 100; // Default: 100% for single-category questions
                let otherCategories = [];

                if (isCrossCategory) {
                  const thisWeightEntry = q.categoryWeights.find(cw => cw.index === categoryIndex);
                  thisCategoryWeight = thisWeightEntry ? Math.round(thisWeightEntry.weight * 100) : 0;
                  // Get other categories this question contributes to
                  // V4.6: Use segment-aware category names
                  otherCategories = q.categoryWeights
                    .filter(cw => cw.index !== categoryIndex)
                    .map(cw => ({
                      name: getCategoryName(cw.index, answers['practice_type']),
                      weight: Math.round(cw.weight * 100),
                      color: categoryColors[cw.index]
                    }));
                }

                return (
                  <div key={q.id} className="glass-card" style={{ padding: 24, animation: `slideInRight 0.5s ease-out ${i * 0.1}s both` }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 }}>
                      <div style={{ fontSize: 15, fontWeight: 600, flex: 1, paddingRight: 20 }}>{q.question}</div>
                      <div style={{ fontSize: 24, fontWeight: 800, fontFamily: "'Archivo'", color: getScoreColor(qScore, segment),
                        textShadow: `0 0 20px ${getScoreColor(qScore, segment)}30` }}>{qScore}</div>
                    </div>
                    <div style={{ fontSize: 14, color: 'var(--text-tertiary)' }}>
                      Your answer: <span style={{ color: 'var(--text-primary)', fontWeight: 500 }}>
                        {Array.isArray(answer) ? answer.join(', ') : answer}{q.unit || ''}
                      </span>
                    </div>
                    {/* V4.4: Show cross-category indicator */}
                    {isCrossCategory && (
                      <div style={{
                        marginTop: 12,
                        display: 'flex',
                        alignItems: 'center',
                        gap: 8,
                        flexWrap: 'wrap',
                        padding: '8px 12px',
                        background: 'rgba(255,255,255,0.03)',
                        borderRadius: 8,
                        border: '1px solid rgba(255,255,255,0.08)'
                      }}>
                        <span style={{ fontSize: 11, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: 1 }}>
                          Cross-Category:
                        </span>
                        <span style={{
                          fontSize: 12,
                          fontWeight: 600,
                          padding: '2px 8px',
                          borderRadius: 100,
                          background: `${categoryColors[categoryIndex]}20`,
                          color: categoryColors[categoryIndex]
                        }}>
                          {thisCategoryWeight}% here
                        </span>
                        {otherCategories.map((oc, idx) => (
                          <span key={idx} style={{
                            fontSize: 12,
                            fontWeight: 600,
                            padding: '2px 8px',
                            borderRadius: 100,
                            background: `${oc.color}20`,
                            color: oc.color
                          }}>
                            {oc.weight}% {oc.name}
                          </span>
                        ))}
                      </div>
                    )}
                    <div style={{ marginTop: 12, height: 4, background: 'var(--bg-tertiary)', borderRadius: 2, overflow: 'hidden' }}>
                      <div style={{ height: '100%', width: `${qScore}%`, background: getScoreColor(qScore, segment), borderRadius: 2,
                        animation: 'barGrow 0.8s ease-out forwards', transformOrigin: 'left' }} />
                    </div>
                  </div>
                );
              })}
            </div>
            <NavButtons />
          </div>
        );
      };

      // Slide 3: Actionable Improvements with Score Projections (V4.7)
      const ImprovementsSlide = () => {
        const topRecs = projections.topImprovements;
        const additionalRecs = projections.additionalImprovements;

        // Calculate cumulative scores for stacked visualization
        const cumulativeScores = topRecs.reduce((acc, imp, i) => {
          const prevScore = i === 0 ? scores.overall : acc[i - 1];
          acc.push(Math.min(100, prevScore + imp.overallImpact));
          return acc;
        }, []);

        // Category colors for the impact badges
        const getCategoryColor = (imp) => {
          const ops = imp.categoryImpacts[0] || 0;
          const fam = imp.categoryImpacts[1] || 0;
          const comp = imp.categoryImpacts[2] || 0;
          if (ops >= fam && ops >= comp) return '#3c8fc7';
          if (fam >= ops && fam >= comp) return '#8B5CF6';
          return '#fcc93b';
        };

        return (
          <div>
            <div style={{ marginBottom: 32 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#3c8fc7', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 12 }}>
                Top {topRecs.length} Recommendations
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 36, fontWeight: 700, marginBottom: 12,
                background: 'linear-gradient(135deg, #3c8fc7, #fcc93b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Actionable Improvements
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 17, lineHeight: 1.6 }}>
                These are the five highest-impact improvements for your organization. Implementing all five could increase your overall score by up to {projections.overallImprovement} points.
              </p>
            </div>

            {/* V4.13: Removed Triple Win Framework Banner from this slide - it appears on Vision slide instead */}

            {/* Cumulative Score Progress Bar */}
            <div className="glass-card" style={{ padding: 20, marginBottom: 24, background: 'linear-gradient(135deg, rgba(16,185,129,0.06), rgba(60,143,199,0.04))' }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                <span style={{ fontSize: 13, color: 'var(--text-muted)', fontWeight: 600 }}>Score Progression</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <span style={{ fontSize: 20, fontWeight: 700, color: 'var(--text-tertiary)' }}>{scores.overall}</span>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <span style={{ fontSize: 20, fontWeight: 800, color: '#10B981' }}>{projections.projected.overall}</span>
                </div>
              </div>
              <div style={{ position: 'relative', height: 12, background: 'rgba(255,255,255,0.05)', borderRadius: 6, overflow: 'hidden' }}>
                {/* Base score bar */}
                <div style={{
                  position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 6,
                  width: `${scores.overall}%`, background: 'var(--text-tertiary)', opacity: 0.4
                }} />
                {/* Projected score bar */}
                <div style={{
                  position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 6,
                  width: `${projections.projected.overall}%`,
                  background: 'linear-gradient(90deg, #3c8fc7, #10B981)',
                  transition: 'width 1s ease-out'
                }} />
                {/* Score markers */}
                <div style={{
                  position: 'absolute', left: `${scores.overall}%`, top: -6, bottom: -6, width: 2,
                  background: '#fff', opacity: 0.6
                }} />
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                  <div style={{ width: 12, height: 12, background: 'var(--text-tertiary)', opacity: 0.4, borderRadius: 2 }} />
                  <span style={{ fontSize: 12, color: 'var(--text-secondary)', fontWeight: 600 }}>Your Current Score: {scores.overall}</span>
                </div>
                <span style={{ fontSize: 12, color: '#10B981', fontWeight: 700 }}>
                  +{projections.overallImprovement} points ({Math.round((projections.overallImprovement / scores.overall) * 100)}% improvement)
                </span>
              </div>
            </div>

            {/* Top 5 Recommendations with cumulative projections */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: 14, marginBottom: 28 }}>
              {topRecs.map((imp, i) => {
                const rec = recommendations.find(r => r.id === imp.id) || {};
                const catColor = getCategoryColor(imp);
                const prevScore = i === 0 ? scores.overall : cumulativeScores[i - 1];
                const currScore = cumulativeScores[i];

                return (
                  <div key={imp.id} className="glass-card" style={{
                    padding: 20, animation: `slideInRight 0.5s ease-out ${i * 0.08}s both`,
                    borderLeft: `4px solid ${catColor}`
                  }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: 14 }}>
                      {/* Rank */}
                      <div style={{
                        width: 32, height: 32, borderRadius: 8, flexShrink: 0,
                        background: `linear-gradient(135deg, ${catColor}30, ${catColor}10)`,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 16, fontWeight: 800, fontFamily: "'Archivo'", color: catColor
                      }}>
                        {i + 1}
                      </div>

                      {/* Content */}
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6, flexWrap: 'wrap' }}>
                          <span style={{
                            padding: '4px 12px', borderRadius: 100, fontSize: 13, fontWeight: 700,
                            background: 'rgba(16,185,129,0.2)', color: '#10B981',
                            textTransform: 'uppercase', letterSpacing: 0.5
                          }}>
                            +{imp.overallImpact} pts
                          </span>
                          {/* Category impact badges */}
                          {imp.categoryImpacts.map((impact, ci) => impact > 0 && (ci < 2 || !useTwoCategories) && (
                            <span key={ci} style={{
                              padding: '2px 6px', borderRadius: 100, fontSize: 9, fontWeight: 600,
                              background: `${categoryColors[ci]}15`, color: categoryColors[ci],
                              letterSpacing: 0.3
                            }}>
                              {getCategoryName(ci, segment).split(' ')[0]} +{impact}
                            </span>
                          ))}
                        </div>
                        <h4 style={{ fontFamily: "'Archivo'", fontSize: 15, fontWeight: 700, marginBottom: 4, lineHeight: 1.3 }}>
                          {rec.title || imp.description}
                        </h4>
                        <p style={{ color: 'var(--text-secondary)', fontSize: 13, lineHeight: 1.4, margin: 0 }}>
                          {imp.description}
                          {imp.sourceRef && (
                            <sup style={{ fontSize: 9, color: 'var(--text-muted)', marginLeft: 2 }}>[{imp.sourceRef}]</sup>
                          )}
                        </p>
                      </div>

                      {/* Cumulative score progression */}
                      <div style={{
                        textAlign: 'center', padding: '10px 14px',
                        background: 'rgba(16,185,129,0.08)', borderRadius: 10,
                        minWidth: 90, flexShrink: 0
                      }}>
                        <div style={{ fontSize: 9, color: 'var(--text-muted)', marginBottom: 2, textTransform: 'uppercase', letterSpacing: 0.5 }}>
                          Running Total
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>
                          <span style={{ fontSize: 15, fontWeight: 600, color: 'var(--text-tertiary)' }}>
                            {prevScore}
                          </span>
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                            <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                          <span style={{ fontSize: 15, fontWeight: 800, color: '#10B981' }}>
                            {currScore}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Additional improvements (always visible) */}
            {additionalRecs.length > 0 && (
              <div style={{ marginBottom: 24 }}>
                <div style={{
                  padding: '14px 20px', marginBottom: 10,
                  background: 'rgba(60,143,199,0.08)', border: '1px solid rgba(60,143,199,0.2)',
                  borderRadius: 10
                }}>
                  <span style={{ fontSize: 14, fontFamily: "'Manrope', sans-serif", color: 'var(--text-primary)' }}>
                    <strong>PatientPay also helps with...</strong>
                    <span style={{ color: 'var(--text-muted)', marginLeft: 8 }}>({additionalRecs.length} more improvements)</span>
                  </span>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                  {additionalRecs.map((imp, i) => (
                    <div key={imp.id} style={{
                      padding: '10px 16px', background: 'rgba(255,255,255,0.02)',
                      borderRadius: 8, border: '1px solid var(--border-subtle)',
                      display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                      animation: `slideInRight 0.3s ease-out ${i * 0.05}s both`
                    }}>
                      <span style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{imp.description}</span>
                      <span style={{ fontSize: 11, fontWeight: 600, color: '#10B981', whiteSpace: 'nowrap', marginLeft: 12 }}>+{imp.overallImpact} pts</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <NavButtons />
          </div>
        );
      };

      // Slide 4: PatientPay Vision (V4.7) - Enhanced with animations
      const VisionSlide = () => {
        const categoryCount = useTwoCategories ? 2 : 3;
        const [animateScore, setAnimateScore] = useState(false);

        // Trigger animation on mount
        React.useEffect(() => {
          const timer = setTimeout(() => setAnimateScore(true), 300);
          return () => clearTimeout(timer);
        }, []);

        // Get the level change text
        const currentLevel = getScoreLevel(projections.current.overall, segment);
        const projectedLevel = getScoreLevel(projections.projected.overall, segment);
        const levelImproved = currentLevel !== projectedLevel;

        return (
          <div>
            <div style={{ marginBottom: 32 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#10B981', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 12 }}>
                Your Projected Future
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 36, fontWeight: 700, marginBottom: 12,
                background: 'linear-gradient(135deg, #10B981, #3c8fc7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                With PatientPay
              </h2>
              <p style={{ color: 'var(--text-secondary)', fontSize: 17, lineHeight: 1.6 }}>
                Based on your assessment, here's what your payment operations could achieve.
              </p>
            </div>

            {/* Current vs Projected Score - Enhanced */}
            <div className="glass-card" style={{
              padding: 32, marginBottom: 28, textAlign: 'center',
              background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(60,143,199,0.06))',
              border: '1px solid rgba(16,185,129,0.35)',
              position: 'relative', overflow: 'hidden'
            }}>
              {/* Subtle animated background */}
              <div style={{
                position: 'absolute', inset: 0, opacity: 0.4,
                background: 'radial-gradient(circle at 30% 50%, rgba(16,185,129,0.15) 0%, transparent 50%), radial-gradient(circle at 70% 50%, rgba(60,143,199,0.15) 0%, transparent 50%)'
              }} />

              <div style={{ position: 'relative', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 40, flexWrap: 'wrap' }}>
                {/* Current Score */}
                <div style={{ animation: 'fadeIn 0.5s ease-out' }}>
                  <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 10 }}>
                    Current Score
                  </div>
                  <div style={{ position: 'relative', width: 120, height: 120, margin: '0 auto' }}>
                    <ProgressRing progress={projections.current.overall} size={120} strokeWidth={8} />
                    <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <span style={{ fontSize: 36, fontWeight: 800, fontFamily: "'Archivo'", color: getScoreColor(projections.current.overall, segment) }}>
                        {projections.current.overall}
                      </span>
                    </div>
                  </div>
                  <div style={{ fontSize: 13, color: getScoreColor(projections.current.overall, segment), fontWeight: 600, marginTop: 6 }}>
                    {currentLevel}
                  </div>
                </div>

                {/* Animated Arrow with improvement */}
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 6, animation: 'fadeIn 0.5s ease-out 0.2s both' }}>
                  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" style={{
                    color: '#10B981',
                    animation: animateScore ? 'pulse 2s ease-in-out infinite' : 'none'
                  }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <span style={{
                    padding: '5px 14px', borderRadius: 100,
                    background: 'rgba(16,185,129,0.25)', color: '#10B981',
                    fontSize: 13, fontWeight: 700, whiteSpace: 'nowrap'
                  }}>
                    +{projections.overallImprovement} points
                  </span>
                </div>

                {/* Projected Score - Enhanced glow */}
                <div style={{ animation: 'fadeIn 0.5s ease-out 0.4s both' }}>
                  <div style={{ fontSize: 12, color: '#10B981', textTransform: 'uppercase', letterSpacing: 2, marginBottom: 10, fontWeight: 600 }}>
                    With PatientPay
                  </div>
                  <div style={{ position: 'relative', width: 120, height: 120, margin: '0 auto' }}>
                    <svg width={120} height={120} style={{ transform: 'rotate(-90deg)' }}>
                      <defs>
                        <linearGradient id="projectedGradientV2" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" stopColor="#10B981" />
                          <stop offset="100%" stopColor="#34D399" />
                        </linearGradient>
                        <filter id="glow">
                          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                          <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                          </feMerge>
                        </filter>
                      </defs>
                      <circle cx={60} cy={60} r={52} fill="none" stroke="rgba(16,185,129,0.15)" strokeWidth={8} />
                      <circle cx={60} cy={60} r={52} fill="none" stroke="url(#projectedGradientV2)" strokeWidth={8}
                        strokeLinecap="round" strokeDasharray={327}
                        strokeDashoffset={animateScore ? 327 - (projections.projected.overall / 100) * 327 : 327}
                        style={{
                          filter: 'url(#glow)',
                          transition: 'stroke-dashoffset 1.5s ease-out'
                        }} />
                    </svg>
                    <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <span style={{
                        fontSize: 36, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981',
                        textShadow: '0 0 20px rgba(16,185,129,0.4)'
                      }}>
                        {projections.projected.overall}
                      </span>
                    </div>
                  </div>
                  <div style={{ fontSize: 13, color: '#10B981', fontWeight: 600, marginTop: 6 }}>
                    {projectedLevel}
                    {levelImproved && <span style={{ marginLeft: 4 }}></span>}
                  </div>
                </div>
              </div>

              {/* Level improvement callout */}
              {levelImproved && (
                <div style={{
                  marginTop: 20, padding: '10px 20px', borderRadius: 100, display: 'inline-flex', alignItems: 'center', gap: 8,
                  background: 'rgba(16,185,129,0.15)', border: '1px solid rgba(16,185,129,0.3)',
                  animation: 'fadeIn 0.5s ease-out 0.6s both'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <span style={{ fontSize: 13, fontWeight: 600, color: '#10B981' }}>
                    Move from "{currentLevel}" to "{projectedLevel}"
                  </span>
                </div>
              )}
            </div>

            {/* Category Breakdown - Enhanced with bars */}
            <h3 style={{ fontFamily: "'Archivo'", fontSize: 14, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 14 }}>
              Category Improvements
            </h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 28 }}>
              {projections.categoryImprovements.slice(0, categoryCount).map((cat, i) => (
                <div key={i} className="glass-card" style={{
                  padding: 16,
                  background: `linear-gradient(135deg, ${categoryColors[i]}08, transparent)`,
                  border: `1px solid ${categoryColors[i]}20`,
                  animation: `slideInRight 0.4s ease-out ${i * 0.1}s both`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>
                    <span style={{ fontSize: 13, fontWeight: 600, color: categoryColors[i] }}>{cat.categoryName}</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      <span style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-tertiary)' }}>{cat.currentScore}</span>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                        <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      <span style={{ fontSize: 18, fontWeight: 800, color: '#10B981' }}>{cat.projectedScore}</span>
                      {cat.improvement > 0 && (
                        <span style={{ fontSize: 11, fontWeight: 700, color: '#10B981', padding: '2px 8px', borderRadius: 100, background: 'rgba(16,185,129,0.15)' }}>
                          +{cat.improvement}
                        </span>
                      )}
                    </div>
                  </div>
                  {/* Progress bar comparison */}
                  <div style={{ position: 'relative', height: 8, background: 'rgba(255,255,255,0.05)', borderRadius: 4, overflow: 'hidden' }}>
                    {/* Current score bar */}
                    <div style={{
                      position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 4,
                      width: `${cat.currentScore}%`, background: categoryColors[i], opacity: 0.3
                    }} />
                    {/* Projected score bar */}
                    <div style={{
                      position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 4,
                      width: animateScore ? `${cat.projectedScore}%` : `${cat.currentScore}%`,
                      background: `linear-gradient(90deg, ${categoryColors[i]}, #10B981)`,
                      transition: 'width 1s ease-out'
                    }} />
                  </div>
                </div>
              ))}
            </div>

            {/* Key Capabilities - Compact */}
            <div className="glass-card" style={{ padding: 20 }}>
              <h4 style={{ fontFamily: "'Archivo'", fontSize: 13, fontWeight: 600, marginBottom: 14, color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: 1 }}>
                What PatientPay Enables
              </h4>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 10 }}>
                {[
                  { icon: 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2', label: 'Multi-Guarantor Billing' },
                  { icon: 'M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6', label: 'Automated Payments' },
                  { icon: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12', label: 'Digital Statements' },
                  { icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z', label: 'Convenience Fee Pass-Through' },
                  { icon: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2', label: 'Family Portal' }
                ].map((cap, i) => (
                  <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, animation: `fadeIn 0.4s ease-out ${0.6 + i * 0.1}s both` }}>
                    <div style={{
                      width: 32, height: 32, borderRadius: 8,
                      background: 'rgba(16,185,129,0.1)', border: '1px solid rgba(16,185,129,0.2)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0
                    }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                        <path d={cap.icon} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    </div>
                    <span style={{ fontSize: 13, fontWeight: 500 }}>{cap.label}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* The Smart Practice Decision - Summary Card */}
            {/* Personalization bridge connecting their results to the decision */}
            {segment && (
              <div style={{ marginTop: 28 }}>
                {/* Personalization bridge - connects their projected score to the decision */}
                <div style={{
                  textAlign: 'center',
                  marginBottom: 16,
                  padding: '12px 20px',
                  background: 'linear-gradient(135deg, rgba(16,185,129,0.08), rgba(60,143,199,0.05))',
                  borderRadius: 12,
                  border: '1px solid rgba(16,185,129,0.15)'
                }}>
                  <p style={{
                    fontSize: 14,
                    color: 'var(--text-secondary)',
                    margin: 0
                  }}>
                    Your assessment shows a path from <strong style={{ color: getScoreColor(projections.current.overall, segment) }}>{projections.current.overall}</strong> to <strong style={{ color: '#10B981' }}>{projections.projected.overall}</strong>.
                    {' '}Here's how one platform delivers that improvement:
                  </p>
                </div>

                {/* V4.12.1: Added summary-card-premium class for subtle hover interaction */}
                <div className="glass-card summary-card-premium" style={{
                  padding: 28,
                  background: 'linear-gradient(135deg, rgba(7,33,64,0.95), rgba(7,33,64,0.85))',
                  border: '2px solid rgba(252,201,59,0.4)',
                  position: 'relative',
                  overflow: 'hidden',
                  animation: 'fadeInUp 0.6s ease-out both'
                }}>
                  {/* Decorative corner accents with subtle animation */}
                  <div style={{
                    position: 'absolute',
                    top: 0, left: 0,
                    width: 60, height: 60,
                    background: 'linear-gradient(135deg, rgba(252,201,59,0.2), transparent)',
                    pointerEvents: 'none',
                    animation: 'breathe 4s ease-in-out infinite'
                  }} />
                  <div style={{
                    position: 'absolute',
                    bottom: 0, right: 0,
                    width: 80, height: 80,
                    background: 'radial-gradient(circle, rgba(16,185,129,0.15), transparent)',
                    pointerEvents: 'none',
                    animation: 'breathe 4s ease-in-out infinite 2s'
                  }} />

                  {/* Header */}
                  <div style={{ textAlign: 'center', marginBottom: 24, position: 'relative' }}>
                    <div style={{
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: 8,
                      padding: '8px 20px',
                      background: 'rgba(252,201,59,0.15)',
                      borderRadius: 100,
                      border: '1px solid rgba(252,201,59,0.3)',
                      marginBottom: 12
                    }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style={{ color: '#fcc93b' }}>
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      <span style={{ fontSize: 11, fontWeight: 700, color: '#fcc93b', textTransform: 'uppercase', letterSpacing: 2 }}>
                        The Bottom Line
                      </span>
                    </div>
                    <h3 style={{
                      fontFamily: "'Archivo'",
                      fontSize: 22,
                      fontWeight: 700,
                      color: '#fff',
                      marginBottom: 6,
                      lineHeight: 1.3
                    }}>
                      One Decision That Does Three Things
                    </h3>
                    <p style={{
                      color: 'rgba(255,255,255,0.7)',
                      fontSize: 14,
                      maxWidth: 400,
                      margin: '0 auto'
                    }}>
                      Smart operators don't make three separate investmentsthey make one.
                    </p>
                  </div>

                  {/* Three wins - V4.12.1: Added pillar-card class + staggered animations */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(3, 1fr)',
                    gap: 12,
                    marginBottom: 20
                  }}>
                    {/* Win 1: Efficiency */}
                    <div className="pillar-card" style={{
                      background: 'rgba(60,143,199,0.15)',
                      borderRadius: 12,
                      padding: '16px 12px',
                      border: '1px solid rgba(60,143,199,0.25)',
                      cursor: 'default',
                      animation: 'fadeInUp 0.5s ease-out 0.1s both'
                    }}>
                      <div className="pillar-icon" style={{
                        width: 36, height: 36, borderRadius: 10,
                        background: 'rgba(60,143,199,0.2)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        marginBottom: 10,
                        transition: 'transform 0.3s ease'
                      }}>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ color: '#3c8fc7' }}>
                          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                          <path d="M22 4L12 14.01l-3-3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </div>
                      <div style={{ fontFamily: "'Archivo'", fontSize: 13, fontWeight: 700, color: '#3c8fc7', marginBottom: 6 }}>
                        Improve Efficiency
                      </div>
                      <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.6)', lineHeight: 1.4 }}>
                        96% reduction in processing time  Real-time PCC integration
                      </div>
                    </div>

                    {/* Win 2: Experience */}
                    <div className="pillar-card" style={{
                      background: 'rgba(139,92,246,0.15)',
                      borderRadius: 12,
                      padding: '16px 12px',
                      border: '1px solid rgba(139,92,246,0.25)',
                      cursor: 'default',
                      animation: 'fadeInUp 0.5s ease-out 0.2s both'
                    }}>
                      <div className="pillar-icon" style={{
                        width: 36, height: 36, borderRadius: 10,
                        background: 'rgba(139,92,246,0.2)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        marginBottom: 10,
                        transition: 'transform 0.3s ease'
                      }}>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ color: '#8B5CF6' }}>
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </div>
                      <div style={{ fontFamily: "'Archivo'", fontSize: 13, fontWeight: 700, color: '#8B5CF6', marginBottom: 6 }}>
                        Elevate Experience
                      </div>
                      <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.6)', lineHeight: 1.4 }}>
                        Multi-guarantor billing  Individual statements per family
                      </div>
                    </div>

                    {/* Win 3: Preference (V4.12.1: renamed from Edge) */}
                    <div className="pillar-card" style={{
                      background: 'rgba(252,201,59,0.15)',
                      borderRadius: 12,
                      padding: '16px 12px',
                      border: '1px solid rgba(252,201,59,0.25)',
                      cursor: 'default',
                      animation: 'fadeInUp 0.5s ease-out 0.3s both'
                    }}>
                      <div className="pillar-icon" style={{
                        width: 36, height: 36, borderRadius: 10,
                        background: 'rgba(252,201,59,0.2)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        marginBottom: 10,
                        transition: 'transform 0.3s ease'
                      }}>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ color: '#fcc93b' }}>
                          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </div>
                      <div style={{ fontFamily: "'Archivo'", fontSize: 13, fontWeight: 700, color: '#fcc93b', marginBottom: 6 }}>
                        Gain Preference
                      </div>
                      <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.6)', lineHeight: 1.4 }}>
                        Stand out during tours  Meet modern expectations
                      </div>
                    </div>
                  </div>

                  {/* PatientPay tagline with concrete next step */}
                  <div style={{
                    textAlign: 'center',
                    padding: '16px 20px',
                    background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(60,143,199,0.08))',
                    borderRadius: 10,
                    border: '1px solid rgba(16,185,129,0.25)',
                    animation: 'fadeInUp 0.5s ease-out 0.4s both'
                  }}>
                    <span style={{ fontSize: 14, color: 'rgba(255,255,255,0.85)' }}>
                      <strong style={{ color: '#10B981' }}>PatientPay</strong> is that decision.
                    </span>
                    <div style={{
                      marginTop: 10,
                      paddingTop: 10,
                      borderTop: '1px solid rgba(255,255,255,0.1)'
                    }}>
                      <span style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>
                        Download your full report on the next slide, or
                      </span>
                      <br />
                      <span className="cta-link" style={{
                        fontSize: 12,
                        color: '#10B981',
                        fontWeight: 600,
                        cursor: 'pointer',
                        display: 'inline-block'
                      }}>
                        see how 400+ facilities have modernized their billing 
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <NavButtons />
          </div>
        );
      };

      // Combined Improvements + Vision for SNF (5-slide flow) - Enhanced
      const ImprovementsVisionSlide = () => {
        const topRecs = projections.topImprovements.slice(0, 4); // Show top 4 for combined view
        const additionalRecs = projections.topImprovements.slice(4).concat(projections.additionalImprovements);
        const [showAdditional, setShowAdditional] = useState(false);
        const [animateScore, setAnimateScore] = useState(false);

        // Trigger animation on mount
        React.useEffect(() => {
          const timer = setTimeout(() => setAnimateScore(true), 300);
          return () => clearTimeout(timer);
        }, []);

        // Calculate cumulative scores
        const cumulativeScores = topRecs.reduce((acc, imp, i) => {
          const prevScore = i === 0 ? scores.overall : acc[i - 1];
          acc.push(Math.min(100, prevScore + imp.overallImpact));
          return acc;
        }, []);

        const currentLevel = getScoreLevel(projections.current.overall, segment);
        const projectedLevel = getScoreLevel(projections.projected.overall, segment);
        const levelImproved = currentLevel !== projectedLevel;

        return (
          <div>
            <div style={{ marginBottom: 24 }}>
              <div style={{ fontSize: 14, fontFamily: "'Archivo'", color: '#10B981', letterSpacing: 2, textTransform: 'uppercase', marginBottom: 10 }}>
                Your Path Forward
              </div>
              <h2 style={{ fontFamily: "'Archivo'", fontSize: 32, fontWeight: 700, marginBottom: 10,
                background: 'linear-gradient(135deg, #10B981, #3c8fc7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                With PatientPay
              </h2>
            </div>

            {/* Score Projection (enhanced compact) */}
            <div className="glass-card" style={{
              padding: 20, marginBottom: 20, textAlign: 'center',
              background: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(60,143,199,0.06))',
              border: '1px solid rgba(16,185,129,0.35)',
              position: 'relative', overflow: 'hidden'
            }}>
              <div style={{ position: 'relative', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 28 }}>
                <div>
                  <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 6 }}>Current</div>
                  <div style={{ fontSize: 32, fontWeight: 800, fontFamily: "'Archivo'", color: getScoreColor(projections.current.overall, segment) }}>
                    {projections.current.overall}
                  </div>
                  <div style={{ fontSize: 11, color: getScoreColor(projections.current.overall, segment), fontWeight: 500 }}>{currentLevel}</div>
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style={{ color: '#10B981' }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <span style={{ fontSize: 11, fontWeight: 700, color: '#10B981', marginTop: 4, padding: '2px 10px', borderRadius: 100, background: 'rgba(16,185,129,0.2)' }}>
                    +{projections.overallImprovement}
                  </span>
                </div>
                <div>
                  <div style={{ fontSize: 10, color: '#10B981', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 6, fontWeight: 600 }}>Projected</div>
                  <div style={{ fontSize: 32, fontWeight: 800, fontFamily: "'Archivo'", color: '#10B981', textShadow: '0 0 15px rgba(16,185,129,0.3)' }}>
                    {projections.projected.overall}
                  </div>
                  <div style={{ fontSize: 11, color: '#10B981', fontWeight: 500 }}>
                    {projectedLevel}
                    {levelImproved && <span style={{ marginLeft: 2 }}></span>}
                  </div>
                </div>
              </div>
            </div>

            {/* Top Improvements with cumulative tracking */}
            <h3 style={{ fontFamily: "'Archivo'", fontSize: 12, fontWeight: 600, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 10 }}>
              Top Improvements
            </h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 10, marginBottom: 16 }}>
              {topRecs.map((imp, i) => {
                const rec = recommendations.find(r => r.id === imp.id) || {};
                const prevScore = i === 0 ? scores.overall : cumulativeScores[i - 1];
                const currScore = cumulativeScores[i];

                return (
                  <div key={imp.id} className="glass-card" style={{
                    padding: 14, display: 'flex', alignItems: 'center', gap: 12,
                    animation: `slideInRight 0.4s ease-out ${i * 0.08}s both`
                  }}>
                    <div style={{
                      width: 26, height: 26, borderRadius: 6, flexShrink: 0,
                      background: 'rgba(16,185,129,0.15)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      fontSize: 13, fontWeight: 700, color: '#10B981'
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 2 }}>{rec.title || imp.description}</div>
                      {imp.sourceRef && (
                        <span style={{ fontSize: 9, color: 'var(--text-muted)' }}>[Source {imp.sourceRef}]</span>
                      )}
                    </div>
                    <div style={{ textAlign: 'right', flexShrink: 0 }}>
                      <div style={{ fontSize: 11, fontWeight: 700, color: '#10B981' }}>+{imp.overallImpact}</div>
                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{prevScore}{currScore}</div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Additional improvements (collapsed) */}
            {additionalRecs.length > 0 && (
              <div style={{ marginBottom: 16 }}>
                <button
                  onClick={() => setShowAdditional(!showAdditional)}
                  style={{
                    width: '100%', padding: '10px 14px',
                    background: 'rgba(60,143,199,0.08)', border: '1px solid rgba(60,143,199,0.2)',
                    borderRadius: 8, cursor: 'pointer',
                    display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                    color: 'var(--text-primary)', fontFamily: "'Manrope', sans-serif", fontSize: 12
                  }}
                >
                  <span>
                    <strong>PatientPay also helps with...</strong>
                    <span style={{ color: 'var(--text-muted)', marginLeft: 6 }}>({additionalRecs.length} more)</span>
                  </span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                    style={{ transform: showAdditional ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.3s' }}>
                    <path d="M6 9l6 6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </button>

                {showAdditional && (
                  <div style={{ marginTop: 8, display: 'flex', flexDirection: 'column', gap: 4, animation: 'fadeIn 0.3s ease-out' }}>
                    {additionalRecs.map((imp, i) => (
                      <div key={imp.id} style={{
                        padding: '8px 12px', background: 'rgba(255,255,255,0.02)',
                        borderRadius: 6, border: '1px solid var(--border-subtle)',
                        display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                        animation: `slideInRight 0.3s ease-out ${i * 0.05}s both`
                      }}>
                        <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{imp.description}</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#10B981', marginLeft: 8 }}>+{imp.overallImpact}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Category improvements (enhanced with bars) */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
              {projections.categoryImprovements.slice(0, 2).map((cat, i) => (
                <div key={i} className="glass-card" style={{
                  padding: 14,
                  background: `linear-gradient(135deg, ${categoryColors[i]}08, transparent)`,
                  border: `1px solid ${categoryColors[i]}20`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                    <span style={{ fontSize: 12, fontWeight: 600, color: categoryColors[i] }}>{cat.categoryName}</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ fontSize: 16, fontWeight: 700, color: 'var(--text-tertiary)' }}>{cat.currentScore}</span>
                      <span style={{ color: '#10B981', fontSize: 12 }}></span>
                      <span style={{ fontSize: 16, fontWeight: 800, color: '#10B981' }}>{cat.projectedScore}</span>
                      {cat.improvement > 0 && (
                        <span style={{ fontSize: 10, fontWeight: 700, color: '#10B981', padding: '1px 6px', borderRadius: 100, background: 'rgba(16,185,129,0.15)' }}>
                          +{cat.improvement}
                        </span>
                      )}
                    </div>
                  </div>
                  <div style={{ position: 'relative', height: 6, background: 'rgba(255,255,255,0.05)', borderRadius: 3, overflow: 'hidden' }}>
                    <div style={{
                      position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 3,
                      width: `${cat.currentScore}%`, background: categoryColors[i], opacity: 0.3
                    }} />
                    <div style={{
                      position: 'absolute', left: 0, top: 0, height: '100%', borderRadius: 3,
                      width: animateScore ? `${cat.projectedScore}%` : `${cat.currentScore}%`,
                      background: `linear-gradient(90deg, ${categoryColors[i]}, #10B981)`,
                      transition: 'width 1s ease-out'
                    }} />
                  </div>
                </div>
              ))}
            </div>

            <NavButtons />
          </div>
        );
      };

      // Slide 5 (or 4 for SNF): Next Steps
      const NextStepsSlide = () => {
        const [pdfLoading, setPdfLoading] = useState(false);

        const handleDownloadPDF = async () => {
          setPdfLoading(true);
          try {
            await downloadPDFReport(formData, answers, scores);
          } catch (err) {
            console.error('PDF download failed:', err);
          }
          setPdfLoading(false);
        };

        return (
          <div>
            <h2 style={{ fontFamily: "'Archivo'", fontSize: 36, fontWeight: 700, marginBottom: 12,
              background: 'linear-gradient(135deg, #fff, #3c8fc7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
              Next Steps
            </h2>
            <p style={{ color: 'var(--text-secondary)', marginBottom: 40, fontSize: 17 }}>
              Ready to build a more resilient practice?
            </p>

            {/* Download Report Card */}
            <div className="glass-card" style={{
              padding: 32, marginBottom: 24,
              background: 'linear-gradient(135deg, rgba(16,185,129,0.1), rgba(60,143,199,0.08))',
              border: '1px solid rgba(16,185,129,0.3)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 20 }}>
                <div style={{
                  width: 56, height: 56, borderRadius: 14,
                  background: 'linear-gradient(135deg, #10b981, #3c8fc7)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0
                }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
                <div style={{ flex: 1 }}>
                  <h3 style={{ fontFamily: "'Archivo'", fontSize: 20, fontWeight: 700, marginBottom: 6 }}>Download Full Report</h3>
                  <p style={{ color: 'var(--text-secondary)', fontSize: 14, margin: 0 }}>
                    Get a comprehensive PDF with detailed analysis, benchmarks, and personalized recommendations.
                  </p>
                </div>
                <button
                  className="btn-primary"
                  onClick={handleDownloadPDF}
                  disabled={pdfLoading}
                  style={{ padding: '14px 28px', fontSize: 15, flexShrink: 0, opacity: pdfLoading ? 0.7 : 1 }}
                >
                  {pdfLoading ? (
                    <>
                      <span style={{ display: 'inline-block', width: 16, height: 16, border: '2px solid #fff', borderTopColor: 'transparent', borderRadius: '50%', animation: 'spin 0.8s linear infinite', marginRight: 10, verticalAlign: 'middle' }}></span>
                      Generating...
                    </>
                  ) : (
                    <>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ marginRight: 10, verticalAlign: 'middle' }}>
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      Download PDF
                    </>
                  )}
                </button>
              </div>
            </div>

            {/* V4.12.2: Updated CTAs with proper links */}
            <div className="glass-card" style={{
              padding: 40, textAlign: 'center', marginBottom: 24,
              background: 'linear-gradient(135deg, rgba(60,143,199,0.12), rgba(252,201,59,0.08))',
              border: '1px solid rgba(60,143,199,0.3)'
            }}>
              <h3 style={{ fontFamily: "'Archivo'", fontSize: 28, fontWeight: 700, marginBottom: 12 }}>Ready to Get Started?</h3>
              <p style={{ color: 'var(--text-secondary)', marginBottom: 28, fontSize: 17 }}>
                See how PatientPay can help you build a more resilient practice.
              </p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 16, alignItems: 'center' }}>
                <a
                  href="https://www.patientpay.com/contact"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn-primary"
                  style={{ padding: '20px 48px', fontSize: 17, textDecoration: 'none', display: 'inline-flex', alignItems: 'center' }}
                >
                  Contact PatientPay
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style={{ marginLeft: 12 }}>
                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </a>
                <a
                  href="https://www.patientpay.com"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn-secondary"
                  style={{
                    padding: '16px 32px',
                    fontSize: 15,
                    textDecoration: 'none',
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: 10
                  }}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style={{ color: '#3c8fc7' }}>
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  Learn More About PatientPay
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style={{ opacity: 0.7 }}>
                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </a>
              </div>
            </div>

            <div className="glass-card" style={{ padding: 28 }}>
              <h4 style={{ fontFamily: "'Archivo'", fontSize: 16, fontWeight: 700, marginBottom: 16, color: 'var(--text-secondary)' }}>
                Sources
              </h4>
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                {sources.map((source, i) => (
                  <span key={i} style={{
                    padding: '6px 12px', borderRadius: 100, fontSize: 12, fontWeight: 500,
                    background: 'var(--bg-tertiary)', color: 'var(--text-muted)'
                  }}>
                    {source.name}
                  </span>
                ))}
              </div>
            </div>
            <NavButtons />
          </div>
        );
      };

      const renderSlide = () => {
        // All segments: 7 slides: Overview  Strengths  Market Context  Opportunities  Improvements  Vision  Next Steps
        if (false) {
          // Legacy SNF path - removed for resiliency assessment
          switch(currentSlide) {
            case 0: return <OverviewSlide />;
            case 1: return <StrengthsSlide />;
            case 2: return <OpportunitiesSlide />;
            case 3: return <ImprovementsVisionSlide />;
            case 4: return <NextStepsSlide />;
            default: return <OverviewSlide />;
          }
        } else {
          // Standard: 7 slides with Market Context after Strengths
          switch(currentSlide) {
            case 0: return <OverviewSlide />;
            case 1: return <StrengthsSlide />;
            case 2: return <MarketContextSlide />;  // V4.12.2: NEW - dedicated slide
            case 3: return <OpportunitiesSlide />;
            case 4: return <ImprovementsSlide />;
            case 5: return <VisionSlide />;
            case 6: return <NextStepsSlide />;
            default: return <OverviewSlide />;
          }
        }
      };

      return (
        <div style={{ minHeight: '100vh', padding: '56px 24px', position: 'relative', zIndex: 2 }}>
          <div style={{
            maxWidth: 960, margin: '0 auto',
            opacity: isTransitioning ? 0 : 1,
            transform: isTransitioning ? 'translateY(20px)' : 'translateY(0)',
            transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
          }}>
            {/* Progress indicator */}
            <div style={{ display: 'flex', justifyContent: 'center', gap: 8, marginBottom: 40 }}>
              {Array.from({ length: totalSlides }).map((_, i) => (
                <div key={i} onClick={() => goToSlide(i)} style={{
                  width: currentSlide === i ? 24 : 8, height: 8, borderRadius: 4, cursor: 'pointer',
                  background: currentSlide === i ? 'linear-gradient(135deg, #3c8fc7, #fcc93b)' : i < currentSlide ? '#3c8fc7' : 'var(--bg-tertiary)',
                  transition: 'all 0.3s ease'
                }} />
              ))}
            </div>

            {renderSlide()}
          </div>
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [screen, setScreen] = useState('welcome');
      const [formData, setFormData] = useState({});
      const [answers, setAnswers] = useState({});
      const [questionIndex, setQuestionIndex] = useState(0);
      const [scores, setScores] = useState(null);

      // Use ref to always have access to latest answers (avoids stale closure issues)
      const answersRef = useRef(answers);
      answersRef.current = answers;

      const visibleQuestions = getVisibleQuestions(answers);
      // V4.10: Defensive handling - ensure safeIndex is never negative
      const safeIndex = visibleQuestions.length > 0 ? Math.min(questionIndex, visibleQuestions.length - 1) : 0;
      const currentQuestion = visibleQuestions.length > 0 ? visibleQuestions[safeIndex] : null;

      return (
        <>
          <GradientOrbs />
          <ParticleField />

          {screen === 'welcome' && <WelcomeScreen onStart={() => {
            trackFunnelEvent('begin_clicked');
            setScreen('contact');
          }} />}
          {screen === 'blocked' && <CompetitorBlockedScreen />}
          {screen === 'contact' && <ContactForm
            onSubmit={(data) => {
              // V4.1: Facility type now comes from contact form, set it in answers for question routing
              trackFunnelEvent('contact_submitted', data.facilityType, {
                name: data.name,
                email: data.email,
                organization: data.organization,
                facilityType: data.facilityType
              });
              setFormData(data);
              setAnswers(prev => ({ ...prev, practice_type: data.facilityType }));
              setScreen('questions');
            }}
            onCompetitorBlocked={() => setScreen('blocked')}
          />}
          {screen === 'questions' && currentQuestion && (
            <QuestionCard
              key={currentQuestion.id}  /* V4.10: CRITICAL - Force new component instance when question changes */
              question={currentQuestion}
              answer={answers[currentQuestion.id]}
              selectedSegment={answers['practice_type']}
              onAnswer={(id, val) => setAnswers(prev => ({ ...prev, [id]: val }))}
              onNext={(id, val) => {
                // Use answersRef.current to get the LATEST answers (including any set by onAnswer)
                // This avoids stale closure issues from the 400ms animation delay
                const latestAnswers = answersRef.current;
                const updatedAnswers = { ...latestAnswers, [id]: val };
                const newVisible = getVisibleQuestions(updatedAnswers);

                // Find where we are in the visible question list
                const currentQIdx = newVisible.findIndex(q => q.id === id);
                const nextIdx = currentQIdx + 1;

                // Check if we're done with questions
                if (currentQIdx === -1 || nextIdx >= newVisible.length) {
                  trackFunnelEvent('questions_completed', answersRef.current['practice_type']);
                  setScreen('processing');
                } else {
                  // Track halfway point (only fire once when crossing 50%)
                  const halfwayIdx = Math.floor(newVisible.length / 2);
                  if (nextIdx === halfwayIdx) {
                    trackFunnelEvent('halfway_reached', answersRef.current['practice_type']);
                  }
                  setQuestionIndex(nextIdx);
                }
              }}
              onBack={() => safeIndex > 0 && setQuestionIndex(safeIndex - 1)}
              questionIndex={safeIndex}
              totalQuestions={visibleQuestions.length}
              isFirst={safeIndex === 0}
              isLast={safeIndex === visibleQuestions.length - 1}
            />
          )}
          {screen === 'processing' && <ProcessingScreen onComplete={() => {
            const calculatedScores = calculateScores(answers);
            setScores(calculatedScores);

            // Track successful completion before webhook
            trackFunnelEvent('submission_complete', answers['practice_type']);

            // Send data to webhook (non-blocking)
            sendWebhook(formData, answers, calculatedScores, 'index-production')
              .catch(() => { /* webhook is non-blocking */ });

            setScreen('results');
          }} />}
          {screen === 'results' && scores && (
            <ResultsJourney scores={scores} formData={formData} answers={answers} />
          )}
        </>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);

    // V4.10: Iframe height communication for Webflow embedding
    // V4.13: Restrict postMessage to known parent origins
    const ALLOWED_PARENT_ORIGINS = [
      'https://www.patientpay.com',
      'https://patientpay.com',
      'https://patientpay.webflow.io'
    ];
    function notifyParentHeight() {
      if (window.parent !== window) {
        const height = Math.max(
          document.body.scrollHeight,
          document.body.offsetHeight,
          document.documentElement.scrollHeight
        );
        const msg = { type: 'patientpay-assessment-resize', height: height + 20 };
        ALLOWED_PARENT_ORIGINS.forEach(origin => {
          try { window.parent.postMessage(msg, origin); } catch (e) { /* origin mismatch, expected */ }
        });
      }
    }

    // Notify on load
    window.addEventListener('load', notifyParentHeight);

    // Notify on resize
    window.addEventListener('resize', notifyParentHeight);

    // Notify periodically (content changes during assessment)
    setInterval(notifyParentHeight, 500);

    // Also notify after any DOM changes via MutationObserver
    const observer = new MutationObserver(notifyParentHeight);
    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
  </script>
</body>
</html>
